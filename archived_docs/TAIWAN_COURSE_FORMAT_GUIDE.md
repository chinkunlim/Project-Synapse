# 台湾大学课程导入自动化指南

## 📋 概述

系统现在支持自动化处理台湾大学课程格式的 CSV 导入，包括：

✅ **自动解析课程时间** - 将 "三9/三10/三11" 自动转换为具体的时间段  
✅ **自动计算节次时间** - 根据节次规则（第1节 06:10~07:00 等）自动计算  
✅ **自动生成课程会话** - 为每门课程生成 18 堂课程会话，日期自动计算  
✅ **Google Calendar 集成** - 从 Google Calendar 读取学年学期信息  

## 🎓 课程数据格式

### CSV 列设定

支持以下列名（中英文都可以）：

| 列名 | 英文 | 例子 | 说明 |
|------|------|------|------|
| 学年 | Year | 114 | 学年（台湾纪年） |
| 学期 | Semester | 1 | 学期（1 或 2） |
| 课程代码 | Code | CP__20500 | 课程代码 |
| 课程名称 | Name | 諮商理論與技術 | 课程名称 |
| 教师 | Instructor | /余振民 | 教师名称（可带 `/` 前缀） |
| 上课时间 | Schedule | 三9/三10/三11 | 上课时间格式 |
| 上课时数/学分 | Credits | 3/3 | 上课时数/学分 |

### CSV 示例

```csv
学年,学期,课程代码,课程名称,教师,上课时间,上课时数/学分
114,1,CP__20500,諮商理論與技術,/余振民,三9/三10/三11,3/3
114,1,CS101,資料結構,/王教授,一2/一3/一4,3/3
114,1,CS201,演算法,/李教授,五9/五10,3/3
```

## ⏰ 课程时间格式说明

### 节次时间表

| 节次 | 时间 | 节次 | 时间 |
|------|------|------|------|
| 第1节 | 06:10~07:00 | 第8节 | 13:10~14:00 |
| 第2节 | 07:10~08:00 | 第9节 | 14:10~15:00 |
| 第3节 | 08:10~09:00 | 第10节 | 15:10~16:00 |
| 第4节 | 09:10~10:00 | 第11节 | 16:20~17:10 |
| 第5节 | 10:20~11:10 | 第12节 | 17:20~18:10 |
| 第6节 | 11:20~12:10 | 第13节 | 18:30~19:20 |
| 第7节 | 12:10~13:00 | 第14节 | 19:30~20:20 |

### 星期映射

| 中文 | 英文 | 数字 |
|------|------|------|
| 一 | Mon / Monday | 0 |
| 二 | Tue / Tuesday | 1 |
| 三 | Wed / Wednesday | 2 |
| 四 | Thu / Thursday | 3 |
| 五 | Fri / Friday | 4 |
| 六 | Sat / Saturday | 5 |
| 日 | Sun / Sunday | 6 |

### 上课时间格式支持

以下格式都可以解析：

```
三9              → 星期三 第9节 (14:10~15:00)
三9/三10         → 星期三 第9-10节 (14:10~16:00)
三9/三10/三11    → 星期三 第9-11节 (14:10~17:10)
二2,五4          → 星期二第2节 + 星期五第4节
Wed9/Wed10       → 英文格式
```

## 🗓️ 学年学期信息

### 配置学期日期

系统需要知道每个学期的开始和结束日期，才能生成课程会话。有两种方式：

#### 方式 1️⃣：使用 Google Calendar（推荐）

1. **创建 Google Calendar**
   - 打开 Google Calendar
   - 创建一个新的日历（或使用现有的）

2. **添加学期事件**
   - 为每个学年学期添加两个事件：
     - 开始日期：事件名称为 `114-1-开始` (学年 114，学期 1)
     - 结束日期：事件名称为 `114-1-结束`
   
   示例：
   ```
   事件1: 114-1-开始   日期: 2025-09-01
   事件2: 114-1-结束   日期: 2025-12-31
   事件3: 114-2-开始   日期: 2026-02-01
   事件4: 114-2-结束   日期: 2026-06-30
   ```

3. **获取 iCal URL**
   - 在 Google Calendar 中找到你的日历
   - 点击日历旁的三点菜单 → 设置
   - 向下找到 "日历集成" 或 "Calendar ID"
   - 复制 iCal 格式的 URL：
     ```
     https://calendar.google.com/calendar/ical/{CALENDAR_ID}/public/basic.ics
     ```

4. **配置系统**
   - 编辑 `utils/google_calendar_sync.py`
   - 将 URL 设置到 `CALENDAR_URL` 变量：
     ```python
     CALENDAR_URL = "https://calendar.google.com/calendar/ical/YOUR_CALENDAR_ID/public/basic.ics"
     ```
   - 运行同步：
     ```bash
     python3 utils/google_calendar_sync.py
     ```

#### 方式 2️⃣：手动配置

编辑 `config/course_schedule_config.py`：

```python
SEMESTER_DATABASE = {
    (114, 1): Semester(114, 1, datetime(2025, 9, 1), datetime(2025, 12, 31)),
    (114, 2): Semester(114, 2, datetime(2026, 2, 1), datetime(2026, 6, 30)),
}
```

## 🚀 使用步骤

### 1. 准备课程 CSV 文件

创建一个 CSV 文件，包含课程数据：

```csv
学年,学期,课程代码,课程名称,教师,上课时间,上课时数/学分
114,1,CP__20500,諮商理論與技術,/余振民,三9/三10/三11,3/3
114,1,CS101,資料結構,/王教授,一2/一3,3/3
```

### 2. 访问管理面板

打开浏览器访问：
```
http://localhost:5001/notion
```

### 3. 选择课程数据库

- 在 "CSV 数据导入" 卡片中
- 选择目标数据库：**课程**

### 4. 上传 CSV 文件

- 点击 "选择 CSV 文件"
- 选择你准备的 CSV 文件

### 5. 点击导入

- 点击 "上传并导入"
- 系统会自动：
  - ✅ 解析课程数据
  - ✅ 计算课程时间
  - ✅ 生成 18 堂课程会话
  - ✅ 创建 Notion 页面

## 📊 导入结果示例

### 导入日志

```
✅ 开始上传 CSV: courses.csv
✅ 导入完成：成功 3 筆，失敗 0 筆；已生成 54 堂课程会话
   导入: 3 筆
```

这表示：
- ✅ 导入了 3 门课程
- ✅ 生成了 54 堂课程会话（3 × 18）

### Notion 中的结果

**课程数据库**

| 课程名称 | 教师 | 上课时间 | 学分 |
|---------|------|---------|------|
| 諮商理論與技術 | 余振民 | 星期三 14:10-17:10 | 3 |
| 資料結構 | 王教授 | 星期一 07:10-08:00 | 3 |

**课程会话数据库**

| 课程会话 | 日期 | 课程 |
|---------|------|------|
| 諮商理論與技術 - 第 1 週 | 2025-09-03 | 諮商理論與技術 |
| 諮商理論與技術 - 第 2 週 | 2025-09-10 | 諮商理論與技術 |
| ... | ... | ... |
| 諮商理論與技術 - 第 18 週 | 2025-12-24 | 諮商理論與技術 |

## 🔧 自定义配置

### 修改节次时间

编辑 `config/course_schedule_config.py`：

```python
CLASS_PERIODS = {
    1: (time(6, 10), time(7, 0)),      # 第1节
    2: (time(7, 10), time(8, 0)),      # 第2节
    # ... 其他节次
}
```

### 修改节次数量

编辑课程会话生成逻辑：

在 `intergrations/notion/processor.py` 中的 `_generate_course_sessions` 方法：

```python
# 修改这一行（默认 18）
for session_num in range(1, 19):  # 改为其他数字
```

### 排除假期

在导入时可以排除特定日期（假期）：

```python
exclude_dates = [
    datetime(2025, 10, 10),  # 国庆日
    datetime(2025, 12, 25),  # 圣诞节
]

# 在导入时使用
class_dates = CourseScheduleParser.get_class_dates(
    sessions,
    year,
    semester,
    exclude_dates
)
```

## 💡 使用提示

### 1. 星期几

系统根据学期的具体日期自动计算星期几。确保你的学期日期是正确的。

### 2. 课程名称和教师

- 课程名称和教师可以带 `/` 前缀（系统会自动移除）
- 支持中文和英文

### 3. CSV 编码

- 推荐使用 UTF-8 编码
- 系统也支持 Big5 编码（如 Excel 默认）

### 4. 重复导入

- 每次导入会创建新的课程记录
- 如果要更新，请先删除旧记录或修改 CSV 后重新导入

## ❓ 常见问题

### Q: "三9" 什么时候开始？
A: 星期三第9节，时间是 14:10~15:00（请查看节次时间表）

### Q: 如何同时上 3 节课？
A: 使用 "三9/三10/三11" 格式，系统会自动计算为 14:10~17:10

### Q: 不同星期的课程怎么写？
A: 用逗号分隔，例：`一2,三9,五4`

### Q: 系统如何知道哪一周是哪一天？
A: 从学期的开始日期开始计算。确保学期日期设置正确。

### Q: 什么是"学年"？
A: 台湾使用民国纪年，例：114 年 = 西元 2025 年

### Q: 可以有不同学年的课程吗？
A: 可以，在同一个 CSV 中混合不同学年的课程

## 📝 API 参考

### Python 使用示例

```python
from utils.course_schedule_parser import CourseScheduleParser
from utils.course_import_processor import CourseImportProcessor

# 解析课程数据
course_row = {
    '学年': '114',
    '学期': '1',
    '课程代码': 'CP__20500',
    '课程名称': '諮商理論與技術',
    '教师': '余振民',
    '上课时间': '三9/三10/三11',
    '上课时数/学分': '3/3'
}

result = CourseImportProcessor.parse_course_row(course_row)

# 获取所有上课日期
class_dates = CourseImportProcessor.get_course_dates(result)

# 格式化为 Notion 属性
notion_props = CourseImportProcessor.format_course_for_notion(result)
```

## 🔗 相关文件

- `config/course_schedule_config.py` - 节次时间和学期配置
- `utils/course_schedule_parser.py` - 课程时间解析器
- `utils/course_import_processor.py` - 课程导入处理器
- `utils/google_calendar_sync.py` - Google Calendar 同步

---

祝你使用愉快！如有问题，请检查系统日志。 📚
