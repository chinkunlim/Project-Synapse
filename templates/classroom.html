{% extends "base.html" %}

{% block title %}Classroom | Project Synapse{% endblock %}

{% block content %}

<!-- Header & Controls -->
<!-- Header & Controls -->
<div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
    <div>
        <h2 class="fw-bold text-success mb-1 d-flex align-items-center gap-2">
            <i class="fa-solid fa-graduation-cap"></i> Google Classroom <span
                class="fs-4 text-muted fw-normal">課程管理中樞</span>
        </h2>
        <p class="text-muted mb-0">Course Management Hub / 課程与作業管理</p>
    </div>
    <div class="d-flex align-items-center">
        <button
            class="btn btn-sm btn-warning text-white shadow-sm rounded-circle hover-lift d-flex align-items-center justify-content-center p-0 me-2"
            style="width: 38px; height: 38px;" onclick="authenticate()" title="Link Google Account">
            <i class="fa-solid fa-link"></i>
        </button>
        <button
            class="btn btn-sm btn-white shadow-sm rounded-circle text-secondary hover-lift d-flex align-items-center justify-content-center p-0"
            style="width: 38px; height: 38px;" onclick="loadCourses(true)" title="Refresh Courses">
            <i class="fa-solid fa-rotate"></i>
        </button>
    </div>
</div>

<div class="row g-4 mb-3">
    <div class="col-12">
        <div id="courseList" class="d-flex flex-nowrap align-items-center gap-3 overflow-auto pb-3 px-1"
            style="scroll-snap-type: x mandatory;">
            <!-- Empty State -->
            <div class="col-12 text-center py-5 w-100">
                <div class="bg-white bg-opacity-50 rounded-4 p-5 d-inline-block shadow-sm border border-light">
                    <i class="fa-solid fa-chalkboard fa-3x text-success opacity-25 mb-3"></i>
                    <h5 class="fw-bold text-muted">Ready to Connect</h5>
                    <p class="small text-muted mb-4 opacity-75">Load your courses to start managing.</p>
                    <button class="btn btn-primary px-4 py-2 shadow-lg rounded-pill" onclick="loadCourses()">
                        Load Courses
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Operations Panel (Shows when Course Selected) -->
<div id="opsPanel"
    class="position-fixed bottom-0 start-50 translate-middle-x mb-4 shadow-lg rounded-4 bg-white border border-light p-3"
    style="width: 90%; max-width: 1000px; z-index: 1050; display: none; backdrop-filter: blur(20px); --bs-bg-opacity: 0.9;">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-sliders text-primary me-2"></i> <span
                id="selectedCourseName">Course Tools</span></h5>
        <button class="btn btn-sm btn-circle btn-light"
            onclick="document.getElementById('opsPanel').style.display='none'"><i
                class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- Tabs for Operations -->
    <ul class="nav nav-pills nav-fill mb-3 bg-light rounded-pill p-1 gap-1" id="opsTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active rounded-pill small fw-bold" data-bs-toggle="pill"
                data-bs-target="#tab-students" onclick="showSection('studentSection')">
                <i class="fa-solid fa-users me-1"></i> Students
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill small fw-bold" data-bs-toggle="pill" data-bs-target="#tab-material"
                onclick="showSection('materialSection')">
                <i class="fa-solid fa-paperclip me-1"></i> Materials
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill small fw-bold" data-bs-toggle="pill" data-bs-target="#tab-assignment"
                onclick="showSection('assignmentSection')">
                <i class="fa-solid fa-pen-to-square me-1"></i> Assignment
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill small fw-bold" data-bs-toggle="pill" data-bs-target="#tab-topics"
                onclick="showSection('topicSection')">
                <i class="fa-solid fa-tags me-1"></i> Topics
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill small fw-bold" data-bs-toggle="pill" data-bs-target="#tab-tracking"
                onclick="showSection('submissionSection')">
                <i class="fa-solid fa-chart-pie me-1"></i> Tracking
            </button>
        </li>
    </ul>

    <!-- Operations Content Areas (Only one shows at a time, populated via JS interactions) -->
    <!-- The content is actually existing in Hidden Divs in the DOM to keep logic simple, we just move them here or show/hide them -->
    <!-- Ideally, refactor JS to inject here. For now, we will create placeholders and let existing JS maximize/modalize layout -->

    <!-- IMPORTANT: Because the original JS relies on IDs like 'studentSection' existing in the DOM, 
         we will keep the original structure logic but style the Containers to be cleaner. 
         The "Floating Panel" above is a visual wrapper concept. 
         
         ACTUALLY: Refactoring the entire JS logic for a floating panel is risky for this step. 
         Let's stick to the "Grid Layout" for courses and standard cards for bottom operations, but styled beautifully.
    -->
</div>

<!-- Real Operations Section (Re-styled) -->
<div class="row g-4 mt-2" id="operationsArea">

    <!-- Student Management -->
    <div class="col-md-6" id="studentSection" style="display: none;">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4">
                <h6 class="fw-bold text-uppercase text-secondary small"><i class="fa-solid fa-users text-info me-2"></i>
                    Students</h6>
            </div>
            <div class="card-body">
                <div id="studentList" class="bg-light rounded-3 p-2 text-muted small text-center"
                    style="max-height: 250px; overflow-y: auto;">
                    Select an action.
                </div>
            </div>
        </div>
    </div>

    <!-- Material -->
    <div class="col-md-6" id="materialSection" style="display: none;">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold text-uppercase text-secondary small mb-0"><i
                        class="fa-solid fa-paperclip text-success me-2"></i> Materials</h6>
                <button
                    class="btn btn-sm btn-success text-white shadow-sm rounded-circle hover-lift d-flex align-items-center justify-content-center p-0"
                    style="width: 32px; height: 32px;" onclick="publishMaterial()" title="Publish Material">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            <div class="card-body">
                <input type="text" id="materialTitle" class="form-control mb-2 bg-light border-0" placeholder="Title">
                <textarea id="materialDescription" class="form-control mb-2 bg-light border-0" rows="2"
                    placeholder="Description"></textarea>
                <div class="row g-2 mb-3">
                    <div class="col-6"><select id="materialTopic"
                            class="form-select bg-light border-0 form-select-sm"></select></div>
                    <div class="col-6"><input type="url" id="materialLink"
                            class="form-control bg-light border-0 form-control-sm" placeholder="URL"></div>
                    <div class="col-12">
                        <input type="file" id="materialFile" class="form-control form-control-sm bg-light border-0">
                    </div>
                </div>
                <div class="mb-2">
                    <!-- Custom Dropdown for State -->
                    <div class="dropdown d-inline-block">
                        <button
                            class="btn btn-sm btn-light border border-secondary-subtle dropdown-toggle text-secondary fw-normal px-3 rounded-pill small d-flex align-items-center"
                            type="button" data-bs-toggle="dropdown" aria-expanded="false" style="height: 38px;">
                            <span id="materialStateLabel">Published</span>
                        </button>
                        <ul class="dropdown-menu shadow-sm border-0">
                            <li><a class="dropdown-item" href="#"
                                    onclick="setMaterialState('PUBLISHED', 'Published')">Published</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setMaterialState('DRAFT', 'Draft')">Draft</a>
                            </li>
                        </ul>
                    </div>
                    <input type="hidden" id="materialState" value="PUBLISHED">
                </div>
            </div>
        </div>
    </div>

    <!-- Assignments -->
    <div class="col-md-6" id="assignmentSection" style="display: none;">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold text-uppercase text-secondary small mb-0"><i
                        class="fa-solid fa-pen-to-square text-primary me-2"></i> Assignment</h6>
                <button
                    class="btn btn-sm btn-primary text-white shadow-sm rounded-circle hover-lift d-flex align-items-center justify-content-center p-0"
                    style="width: 32px; height: 32px;" onclick="publishAssignment()" title="Publish Assignment">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-2">
                    <input type="text" id="assignmentTitle" class="form-control bg-light border-0" placeholder="Title">
                    <input type="number" id="assignmentMaxPoints" class="form-control bg-light border-0 w-25"
                        value="100" placeholder="Pts">
                </div>
                <textarea id="assignmentDescription" class="form-control mb-2 bg-light border-0" rows="2"
                    placeholder="Instructions"></textarea>

                <div class="row g-2 mb-3">
                    <div class="col-6"><select id="assignmentTopic"
                            class="form-select bg-light border-0 form-select-sm"></select></div>
                    <div class="col-6">
                        <div class="btn-group w-100 shadow-sm">
                            <button class="btn btn-white btn-sm" id="assignAll"
                                onclick="setAssigneeMode('ALL_STUDENTS')">All</button>
                            <button class="btn btn-white btn-sm" id="assignSome"
                                onclick="setAssigneeMode('INDIVIDUAL_STUDENTS')">Select</button>
                        </div>
                    </div>
                </div>

                <!-- Student Picker (Hidden) -->
                <div id="studentPicker" class="mb-2 bg-white border rounded p-2 small"
                    style="display:none; max-height:100px; overflow-y:auto;"></div>

                <div class="mb-3">
                    <label class="small text-muted mb-1">Due Date</label>
                    <input type="datetime-local" id="assignmentDueDate"
                        class="form-control bg-light border-0 shadow-sm">
                </div>

                <div class="mb-3">
                    <label class="small text-muted mb-1">Grade Category</label>
                    <select id="assignmentGradeCategory" class="form-select bg-light border-0 shadow-sm">
                        <option value="">No Category</option>
                    </select>
                </div>

                <div class="mb-3">
                    <input type="file" id="assignmentFile" class="form-control form-control-sm bg-light border-0">
                </div>

                <div class="mb-3">
                    <!-- Custom Dropdown for State -->
                    <div class="dropdown d-inline-block">
                        <button
                            class="btn btn-sm btn-light border border-secondary-subtle dropdown-toggle text-secondary fw-normal px-3 rounded-pill small d-flex align-items-center"
                            type="button" data-bs-toggle="dropdown" aria-expanded="false" style="height: 38px;">
                            <span id="assignmentStateLabel">Published</span>
                        </button>
                        <ul class="dropdown-menu shadow-sm border-0">
                            <li><a class="dropdown-item" href="#"
                                    onclick="setAssignmentState('PUBLISHED', 'Published')">Published</a></li>
                            <li><a class="dropdown-item" href="#"
                                    onclick="setAssignmentState('DRAFT', 'Draft')">Draft</a></li>
                        </ul>
                    </div>
                    <input type="hidden" id="assignmentState" value="PUBLISHED">
                </div>
            </div>
        </div>
    </div>

    <!-- Tracking -->
    <div class="col-md-6" id="submissionSection" style="display: none;">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4">
                <h6 class="fw-bold text-uppercase text-secondary small"><i
                        class="fa-solid fa-chart-pie text-warning me-2"></i> Tracking</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadAllTracking()">
                        <i class="fa-solid fa-rotate"></i> Refresh
                    </button>
                    <small class="text-muted">Auto-loaded for all assignments</small>
                </div>
                <div id="submissionStats"></div>
            </div>
        </div>
    </div>

    <!-- Topics -->
    <div class="col-md-12" id="topicSection" style="display: none;">
        <div class="card h-100 border-0 shadow-sm bg-primary bg-opacity-10">
            <div class="card-body d-flex align-items-center justify-content-between p-4">
                <h6 class="fw-bold text-primary mb-0"><i class="fa-solid fa-tags me-2"></i> Batch Topics Generator</h6>
                <div class="d-flex gap-2 align-items-center">
                    <input type="number" id="numWeeks" class="form-control border-0 shadow-sm" value="18" min="1"
                        style="width: 80px;" title="Weeks">
                    <input type="text" id="topicPrefix" class="form-control border-0 shadow-sm" value="Week"
                        placeholder="Prefix" style="width: 100px;">
                    <button class="btn btn-primary shadow-sm" onclick="createTopics()">Create</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-white mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loadingMessage" class="fw-light text-white">Processing...</h5>
</div>

<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(10px);
        background: rgba(0, 0, 0, 0.4) !important;
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
        animation: fadeIn 0.2s ease-out;
    }

    .course-card {
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .course-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1) !important;
        border-color: var(--accent-color);
    }

    .btn-transparent.active {
        background-color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
</style>
<script>
    // Helper to toggle sections cleanly in this new layout
    function showSection(sectionId) {
        // Hide all
        ['studentSection', 'materialSection', 'assignmentSection', 'topicSection', 'submissionSection'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        // Show target
        const el = document.getElementById(sectionId);
        if (el) {
            el.style.display = 'block';
            // Scroll to it
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
</script>
<script src="{{ url_for('static', filename='js/classroom.js') }}"></script>
{% endblock %}