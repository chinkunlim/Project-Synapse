<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Classroom ç®¡ç† | Project Synapse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        #courseList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .course-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .course-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .course-item.selected {
            background: #e9f0ff;
            border-color: #667eea;
        }

        .course-item h3 {
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .course-item p {
            color: #666;
            font-size: 0.9rem;
        }

        #statusMessage {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        #statusMessage.success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        #statusMessage.error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }

        #statusMessage.info {
            background: #bee3f8;
            color: #2c5282;
            border: 2px solid #4299e1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">â† è¿”å›é¦–é </a>
        
        <header>
            <h1>ğŸ“š Google Classroom ç®¡ç†</h1>
            <p>èª²ç¨‹ç®¡ç† | å­¸ç”Ÿåå–® | ä¸»é¡Œå»ºç«‹ | èª²ä»¶ç™¼å¸ƒ | ä½œæ¥­è¿½è¹¤</p>
        </header>

        <div id="statusMessage"></div>

        <!-- èªè­‰å€ -->
        <div class="card">
            <h2>ğŸ” èªè­‰è¨­å®š</h2>
            <button class="btn btn-primary" onclick="authenticate()">é€£æ¥ Google Classroom</button>
        </div>

        <!-- èª²ç¨‹é¸æ“‡å€ -->
        <div class="card">
            <h2>ğŸ“‹ èª²ç¨‹åˆ—è¡¨</h2>
            <div class="form-group" style="display:flex; gap:12px; align-items:center;">
                <label>é¡¯ç¤ºç¯„åœ</label>
                <div class="btn-group">
                    <button class="btn" id="roleTeacher" onclick="setRole('teacher')">æˆ‘æ“”ä»»æ•™å¸«</button>
                    <button class="btn" id="roleStudent" onclick="setRole('student')">æˆ‘æ“”ä»»å­¸ç”Ÿ</button>
                    <button class="btn" id="roleAll" onclick="setRole('all')">å…¨éƒ¨èª²ç¨‹</button>
                </div>
                <button class="btn btn-primary" onclick="loadCourses()">è®€å–èª²ç¨‹</button>
                <button class="btn btn-success" onclick="loadAllStudentsTabs()">è¼‰å…¥æ‰€æœ‰èª²å®¤åå–®</button>
                <button class="btn btn-success" onclick="exportAllStudents()">å°å‡ºæ‰€æœ‰åå–®ï¼ˆå–®ä¸€å·¥ä½œç°¿ï¼‰</button>
            </div>
            <div id="courseList"></div>
            <div id="tabs" style="margin-top: 16px;"></div>
            <div id="tabContents"></div>
        </div>

        <!-- å­¸ç”Ÿç®¡ç†å€ -->
        <div class="card" id="studentSection" style="display: none;">
            <h2>ğŸ‘¥ å­¸ç”Ÿç®¡ç†</h2>
            <div class="btn-group">
                <button class="btn btn-success" onclick="viewStudents()">æŸ¥çœ‹å­¸ç”Ÿåå–®</button>
                <button class="btn btn-success" onclick="exportStudents()">å°å‡º Excel</button>
            </div>
            <div id="studentList"></div>
        </div>

        <!-- ä¸»é¡Œå»ºç«‹å€ -->
        <div class="card" id="topicSection" style="display: none;">
            <h2>ğŸ“Œ æ‰¹æ¬¡å»ºç«‹ä¸»é¡Œ</h2>
            <div class="form-group">
                <label>é€±æ•¸ï¼ˆé è¨­ 18 é€±ï¼‰</label>
                <input type="number" id="numWeeks" value="18" min="1" max="52">
            </div>
            <div class="form-group">
                <label>ä¸»é¡Œå‰ç¶´</label>
                <input type="text" id="topicPrefix" value="Week" placeholder="ä¾‹å¦‚: Week, ç¬¬å¹¾é€±">
            </div>
            <button class="btn btn-primary" onclick="createTopics()">å»ºç«‹ä¸»é¡Œ</button>
            <hr>
            <div class="form-group">
                <label>æˆ–ä½¿ç”¨ CSV å°å…¥ä¸»é¡Œï¼ˆç¬¬ä¸€æ¬„ç‚ºä¸»é¡Œåç¨±ï¼‰</label>
                <input type="file" id="topicCsv" accept=".csv">
            </div>
            <button class="btn btn-success" onclick="importTopicsFromCSV()">å¾ CSV å°å…¥ä¸»é¡Œ</button>
        </div>

        <!-- èª²ä»¶ç™¼å¸ƒå€ -->
        <div class="card" id="materialSection" style="display: none;">
            <h2>ğŸ“ ç™¼å¸ƒèª²ä»¶</h2>
            <div class="form-group">
                <label>èª²ä»¶æ¨™é¡Œ</label>
                <input type="text" id="materialTitle" placeholder="ä¾‹å¦‚: ç¬¬ä¸€é€±ä¸Šèª²è¬›ç¾©">
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="materialDescription" rows="3" placeholder="èª²ä»¶èªªæ˜..."></textarea>
            </div>
            <div class="form-group">
                <label>é¸æ“‡ä¸»é¡Œ</label>
                <select id="materialTopic">
                    <option value="">ç„¡ä¸»é¡Œ</option>
                </select>
            </div>
            <div class="form-group">
                <label>å¤–éƒ¨é€£çµï¼ˆé¸å¡«ï¼‰</label>
                <input type="url" id="materialLink" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>ä¸Šå‚³æª”æ¡ˆï¼ˆé¸å¡«ï¼‰</label>
                <input type="file" id="materialFile">
            </div>
            <div class="form-group">
                <label>æˆ–å¾ Google Drive é¸å–</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="driveQuery" placeholder="é—œéµå­—æœå°‹">
                    <button class="btn" onclick="searchDrive()">æœå°‹</button>
                </div>
                <div id="driveResults" style="max-height:200px; overflow:auto; margin-top:8px;"></div>
            </div>
            <div class="form-group">
                <label>ç™¼å¸ƒç‹€æ…‹</label>
                <select id="materialState">
                    <option value="PUBLISHED">ç«‹å³ç™¼å¸ƒ</option>
                    <option value="DRAFT">å„²å­˜è‰ç¨¿</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="publishMaterial()">ç™¼å¸ƒèª²ä»¶</button>
        </div>

        <!-- ä½œæ¥­è¿½è¹¤å€ -->
        <div class="card" id="submissionSection" style="display: none;">
            <h2>ğŸ“Š ä½œæ¥­å‘ˆäº¤é€²åº¦</h2>
            <div class="form-group">
                <label>é¸æ“‡ä½œæ¥­</label>
                <select id="courseworkSelect">
                    <option value="">è«‹å…ˆé¸æ“‡ä½œæ¥­</option>
                </select>
            </div>
            <button class="btn btn-warning" onclick="checkSubmissions()">æª¢æŸ¥é€²åº¦</button>
            <div id="submissionStats" class="stats-grid"></div>
        </div>

        <!-- ä½œæ¥­ç™¼å¸ƒå€ -->
        <div class="card" id="assignmentSection" style="display: none;">
            <h2>ğŸ“ ç™¼å¸ƒä½œæ¥­</h2>
            <div class="form-group">
                <label>ä½œæ¥­æ¨™é¡Œ</label>
                <input type="text" id="assignmentTitle" placeholder="ä¾‹å¦‚ï¼šç¬¬ 1 é€±ä½œæ¥­">
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="assignmentDescription" rows="3" placeholder="ä½œæ¥­èªªæ˜..."></textarea>
            </div>
            <div class="form-group">
                <label>æ»¿åˆ†ï¼ˆé¸å¡«ï¼‰</label>
                <input type="number" id="assignmentMaxPoints" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š100">
            </div>
            <div class="form-group">
                <label>åˆ°æœŸæ—¥ï¼ˆé¸å¡«ï¼‰</label>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="dueYear" placeholder="å¹´" min="2020" style="width:100px;">
                    <input type="number" id="dueMonth" placeholder="æœˆ" min="1" max="12" style="width:80px;">
                    <input type="number" id="dueDay" placeholder="æ—¥" min="1" max="31" style="width:80px;">
                </div>
            </div>
            <div class="form-group">
                <label>é¸æ“‡ä¸»é¡Œï¼ˆé¸å¡«ï¼‰</label>
                <select id="assignmentTopic">
                    <option value="">ç„¡ä¸»é¡Œ</option>
                </select>
            </div>
            <div class="form-group">
                <label>å°è±¡</label>
                <div class="btn-group">
                    <button class="btn" id="assignAll" onclick="setAssigneeMode('ALL_STUDENTS')">å…¨éƒ¨å­¸ç”Ÿ</button>
                    <button class="btn" id="assignSome" onclick="setAssigneeMode('INDIVIDUAL_STUDENTS')">æŒ‡å®šå­¸ç”Ÿ</button>
                </div>
                <div id="studentPicker" style="display:none; max-height:200px; overflow:auto; border:1px solid #eee; padding:8px; margin-top:8px;"></div>
            </div>
            <div class="form-group">
                <label>é™„ä»¶ï¼ˆé¸å¡«ï¼‰</label>
                <input type="file" id="assignmentFile">
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <input type="url" id="assignmentLink" placeholder="https://...">
                    <button class="btn" onclick="addAssignmentLink()">åŠ å…¥é€£çµ</button>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <input type="text" id="assignmentDriveQuery" placeholder="Drive é—œéµå­—">
                    <button class="btn" onclick="searchAssignmentDrive()">æœå°‹ Drive</button>
                </div>
                <div id="assignmentDriveResults" style="max-height:200px; overflow:auto; margin-top:8px;"></div>
            </div>
            <div class="form-group">
                <label>Grade Category IDï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="gradeCategoryId" placeholder="ä¾‹å¦‚ï¼š1234567890">
            </div>
            <div class="form-group">
                <label>Grading Period IDï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="gradingPeriodId" placeholder="ä¾‹å¦‚ï¼šabcdef">
            </div>
            <div class="form-group">
                <label>åˆ°æœŸæ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="dueHour" min="0" max="23" placeholder="æ™‚" style="width:80px;">
                    <input type="number" id="dueMinute" min="0" max="59" placeholder="åˆ†" style="width:80px;">
                </div>
            </div>
            <div class="form-group">
                <label>ç™¼å¸ƒç‹€æ…‹</label>
                <select id="assignmentState">
                    <option value="PUBLISHED">ç«‹å³ç™¼å¸ƒ</option>
                    <option value="DRAFT">å„²å­˜è‰ç¨¿</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="publishAssignment()">ç™¼å¸ƒä½œæ¥­</button>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: white;">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
    </div>

    <script>
        let selectedCourseId = null;
        let selectedCourseName = null;

        function showMessage(message, type = 'info') {
            const msgBox = document.getElementById('statusMessage');
            msgBox.textContent = message;
            msgBox.className = type;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 5000);
        }

        function showLoading(show = true) {
            document.getElementById('loadingIndicator').classList.toggle('active', show);
        }

        async function authenticate() {
            showLoading(true);
            try {
                const response = await fetch('/api/classroom/authenticate', {
                    method: 'POST'
                });
                const data = await response.json();
                showMessage(data.message, data.status);
            } catch (error) {
                showMessage('èªè­‰å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
            async function authenticate() {
                try {
                    showLoading('æ­£åœ¨å–å¾—æˆæ¬Šç¶²å€...');
                    const resp = await fetch('/api/classroom/auth/start');
                    const data = await resp.json();
                    if (data.status === 'success' && data.authorization_url) {
                        showMessage('ğŸ‘‰ æ­£åœ¨é–‹å•Ÿ Google æˆæ¬Šé é¢...');
                        window.location.href = data.authorization_url;
                    } else {
                        showMessage('âŒ ' + (data.message || 'å–å¾—æˆæ¬Šç¶²å€å¤±æ•—'));
                    }
                } catch (e) {
                    showMessage('âŒ èªè­‰éŒ¯èª¤: ' + e.message);
                } finally {
                    hideLoading();
                }
            }

        let currentRole = 'teacher';
        function setRole(role) {
            currentRole = role;
            ['roleTeacher','roleStudent','roleAll'].forEach(id => document.getElementById(id).classList.remove('btn-primary'));
            if (role === 'teacher') document.getElementById('roleTeacher').classList.add('btn-primary');
            else if (role === 'student') document.getElementById('roleStudent').classList.add('btn-primary');
            else document.getElementById('roleAll').classList.add('btn-primary');
            // é»æ“Šè§’è‰²å¾Œè‡ªå‹•è¼‰å…¥èª²ç¨‹
            loadCourses();
        }
        setRole('teacher');

        async function loadCourses() {
            showLoading(true);
            try {
                const role = currentRole;
                const url = role === 'all' ? '/api/classroom/courses' : `/api/classroom/courses?role=${role}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const courseList = document.getElementById('courseList');
                    courseList.innerHTML = '';
                    
                    data.courses.forEach(course => {
                        const div = document.createElement('div');
                        div.className = 'course-item';
                        div.innerHTML = `
                            <h3>${course.name}</h3>
                            <p>${course.section || 'ç„¡ç­ç´šè³‡è¨Š'}</p>
                            <p style="font-size: 0.8rem; color: #999;">ID: ${course.id}</p>
                        `;
                        div.onclick = () => selectCourse(course.id, course.name, div);
                        courseList.appendChild(div);
                    });
                    
                    showMessage(`å·²è¼‰å…¥ ${data.count} å€‹èª²ç¨‹ï¼ˆ${data.role || role}ï¼‰`, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('è¼‰å…¥èª²ç¨‹å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadAllStudentsTabs() {
            showLoading(true);
            try {
                const role = currentRole;
                const url = role === 'all' ? '/api/classroom/courses' : `/api/classroom/courses?role=${role}`;
                const resp = await fetch(url);
                const data = await resp.json();
                if (data.status !== 'success') {
                    showMessage(data.message || 'è¼‰å…¥èª²ç¨‹å¤±æ•—', 'error');
                    return;
                }
                const courses = data.courses;
                const tabs = document.getElementById('tabs');
                const contents = document.getElementById('tabContents');
                tabs.innerHTML = '';
                contents.innerHTML = '';
                let first = true;
                for (const course of courses) {
                    const tab = document.createElement('button');
                    tab.className = 'btn';
                    tab.textContent = course.name;
                    tab.onclick = () => {
                        document.querySelectorAll('#tabContents > div').forEach(d => d.style.display = 'none');
                        document.getElementById('tab-'+course.id).style.display = 'block';
                    };
                    tabs.appendChild(tab);

                    const panel = document.createElement('div');
                    panel.id = 'tab-'+course.id;
                    panel.style.display = first ? 'block' : 'none';
                    panel.innerHTML = `<h3>${course.name}</h3><div class="students"></div>`;
                    contents.appendChild(panel);

                    const resStu = await fetch(`/api/classroom/students/${course.id}`);
                    const dataStu = await resStu.json();
                    if (dataStu.status === 'success') {
                        const studentsDiv = panel.querySelector('.students');
                        studentsDiv.innerHTML = '';
                        dataStu.students.forEach(s => {
                            const div = document.createElement('div');
                            div.style.padding = '8px';
                            div.style.borderBottom = '1px solid #eee';
                            div.innerHTML = `<strong>${s.profile.name}</strong><br><small>${s.profile.emailAddress}</small>`;
                            studentsDiv.appendChild(div);
                        });
                    } else {
                        panel.querySelector('.students').innerHTML = `<p class='error'>${dataStu.message || 'è®€å–å­¸ç”Ÿå¤±æ•—'}</p>`;
                    }
                    first = false;
                }
                showMessage(`å·²è¼‰å…¥ ${courses.length} å€‹èª²å®¤çš„åå–®`, 'success');
            } catch (e) {
                showMessage('è¼‰å…¥åå–®å¤±æ•—: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportAllStudents() {
            try {
                const role = currentRole;
                const url = role === 'all' ? '/api/classroom/students/export_all' : `/api/classroom/students/export_all?role=${role}`;
                window.location.href = url;
            } catch (e) {
                showMessage('å°å‡ºå¤±æ•—: ' + e.message, 'error');
            }
        }

        function selectCourse(courseId, courseName, element) {
            // æ¸…é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.course-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedCourseId = courseId;
            selectedCourseName = courseName;
            
            // é¡¯ç¤ºç›¸é—œåŠŸèƒ½å€å¡Š
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('topicSection').style.display = 'block';
            document.getElementById('materialSection').style.display = 'block';
            document.getElementById('submissionSection').style.display = 'block';
            document.getElementById('assignmentSection').style.display = 'block';
            
            // è¼‰å…¥ä¸»é¡Œåˆ—è¡¨ä¾›èª²ä»¶é¸æ“‡
            loadTopics(courseId);
            // åŒæ­¥ä¸»é¡Œè‡³ä½œæ¥­é¸æ“‡
            syncTopicsToAssignment();
            // è¼‰å…¥ä½œæ¥­åˆ—è¡¨
            loadCoursework(courseId);
            
            showMessage(`å·²é¸æ“‡èª²ç¨‹: ${courseName}`, 'success');
        }

        async function viewStudents() {
            if (!selectedCourseId) {
                showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch(`/api/classroom/students/${selectedCourseId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const studentList = document.getElementById('studentList');
                    studentList.innerHTML = '<h3>å­¸ç”Ÿåå–®</h3>';
                    
                    data.students.forEach(student => {
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.borderBottom = '1px solid #eee';
                        div.innerHTML = `
                            <strong>${student.profile.name}</strong><br>
                            <small>${student.profile.emailAddress}</small>
                        `;
                        studentList.appendChild(div);
                    });
                    
                    showMessage(`å…± ${data.count} ä½å­¸ç”Ÿ`, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('è¼‰å…¥å­¸ç”Ÿåå–®å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportStudents() {
            if (!selectedCourseId) {
                showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                return;
            }
            
            showLoading(true);
            try {
                window.location.href = `/api/classroom/students/${selectedCourseId}/export?course_name=${encodeURIComponent(selectedCourseName)}`;
                showMessage('é–‹å§‹ä¸‹è¼‰å­¸ç”Ÿåå–® Excel', 'success');
            } catch (error) {
                showMessage('å°å‡ºå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function createTopics() {
            if (!selectedCourseId) {
                showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                return;
            }
            
            const numWeeks = document.getElementById('numWeeks').value;
            const prefix = document.getElementById('topicPrefix').value;
            
            showLoading(true);
            try {
                const response = await fetch('/api/classroom/topics/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        course_id: selectedCourseId,
                        num_weeks: parseInt(numWeeks),
                        prefix: prefix
                    })
                });
                const data = await response.json();
                showMessage(data.message, data.status);
                
                if (data.status === 'success') {
                    loadTopics(selectedCourseId);
                }
            } catch (error) {
                showMessage('å»ºç«‹ä¸»é¡Œå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadTopics(courseId) {
            try {
                const response = await fetch(`/api/classroom/topics/${courseId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const select = document.getElementById('materialTopic');
                    select.innerHTML = '<option value="">ç„¡ä¸»é¡Œ</option>';
                    const select2 = document.getElementById('assignmentTopic');
                    select2.innerHTML = '<option value="">ç„¡ä¸»é¡Œ</option>';
                    
                    data.topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.topicId;
                        option.textContent = topic.name;
                        select.appendChild(option);
                        const option2 = document.createElement('option');
                        option2.value = topic.topicId;
                        option2.textContent = topic.name;
                        select2.appendChild(option2);
                    });
                }
                    function syncTopicsToAssignment() {
                        const materialSelect = document.getElementById('materialTopic');
                        const assignmentSelect = document.getElementById('assignmentTopic');
                        assignmentSelect.innerHTML = materialSelect.innerHTML;
                    }

                    let assigneeMode = 'ALL_STUDENTS';
                    let selectedStudentIds = [];
                    let assignmentLinks = [];
                    let selectedAssignmentDriveFileIds = [];
                    function setAssigneeMode(mode) {
                        assigneeMode = mode;
                        document.getElementById('assignAll').classList.toggle('btn-primary', mode==='ALL_STUDENTS');
                        document.getElementById('assignSome').classList.toggle('btn-primary', mode==='INDIVIDUAL_STUDENTS');
                        document.getElementById('studentPicker').style.display = mode==='INDIVIDUAL_STUDENTS' ? 'block' : 'none';
                        if (mode==='INDIVIDUAL_STUDENTS') loadStudentsForPicker();
                    }
                    function loadStudentsForPicker() {
                        fetch(`/api/classroom/students/${selectedCourseId}`).then(r=>r.json()).then(data=>{
                            const picker = document.getElementById('studentPicker');
                            picker.innerHTML='';
                            if (data.status==='success') {
                                data.students.forEach(s=>{
                                    const id = s.userId;
                                    const label = document.createElement('label');
                                    label.style.display='block';
                                    const cb = document.createElement('input');
                                    cb.type='checkbox';
                                    cb.value=id;
                                    cb.onchange = (e)=>{
                                        if (e.target.checked) selectedStudentIds.push(id); else selectedStudentIds = selectedStudentIds.filter(x=>x!==id);
                                    };
                                    label.appendChild(cb);
                                    label.appendChild(document.createTextNode(' '+s.profile.name+' ('+ (s.profile.emailAddress||'') +')'));
                                    picker.appendChild(label);
                                });
                            }
                        });
                    }
                    function addAssignmentLink(){
                        const url = document.getElementById('assignmentLink').value.trim();
                        if (!url) return;
                        assignmentLinks.push(url);
                        document.getElementById('assignmentLink').value='';
                        showMessage('å·²åŠ å…¥é€£çµ');
                    }
                    async function searchAssignmentDrive(){
                        const q = document.getElementById('assignmentDriveQuery').value;
                        const resp = await fetch(`/api/drive/files?q=${encodeURIComponent(q)}`);
                        const data = await resp.json();
                        if (data.status==='success'){
                            const container = document.getElementById('assignmentDriveResults');
                            container.innerHTML='';
                            data.files.forEach(f=>{
                                const div = document.createElement('div');
                                div.style.padding='8px';
                                div.style.borderBottom='1px solid #eee';
                                div.innerHTML = `<strong>${f.name}</strong> <small>(${f.mimeType})</small>`;
                                div.onclick = ()=>{
                                    selectedAssignmentDriveFileIds.push(f.id);
                                    div.style.background = '#e3f2fd';
                                };
                                container.appendChild(div);
                            });
                        }
                    }

                    async function publishAssignment() {
                        if (!selectedCourseId) {
                            showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                            return;
                        }
                        const title = document.getElementById('assignmentTitle').value;
                        if (!title) { showMessage('è«‹è¼¸å…¥ä½œæ¥­æ¨™é¡Œ', 'error'); return; }
                        const fd = new FormData();
                        fd.append('course_id', selectedCourseId);
                        fd.append('title', title);
                        fd.append('description', document.getElementById('assignmentDescription').value);
                        fd.append('max_points', document.getElementById('assignmentMaxPoints').value);
                        fd.append('topic_id', document.getElementById('assignmentTopic').value);
                        fd.append('state', document.getElementById('assignmentState').value);
                        fd.append('assignee_mode', assigneeMode);
                        fd.append('student_ids', selectedStudentIds.join(','));
                        fd.append('drive_file_ids', selectedAssignmentDriveFileIds.join(','));
                        fd.append('links', assignmentLinks.join(','));
                        fd.append('grade_category_id', document.getElementById('gradeCategoryId').value);
                        fd.append('grading_period_id', document.getElementById('gradingPeriodId').value);
                        fd.append('due_year', document.getElementById('dueYear').value);
                        fd.append('due_month', document.getElementById('dueMonth').value);
                        fd.append('due_day', document.getElementById('dueDay').value);
                        fd.append('due_hour', document.getElementById('dueHour').value);
                        fd.append('due_minute', document.getElementById('dueMinute').value);
                        fd.append('due_year', document.getElementById('dueYear').value);
                        fd.append('due_month', document.getElementById('dueMonth').value);
                        fd.append('due_day', document.getElementById('dueDay').value);
                        showLoading(true);
                        try {
                            // ä¸Šå‚³é™„ä»¶æª”æ¡ˆåˆ° Drive ä¸¦åŠ å…¥ materials
                            const fileInput = document.getElementById('assignmentFile');
                            if (fileInput.files && fileInput.files[0]) {
                                const upfd = new FormData();
                                upfd.append('course_id', selectedCourseId);
                                upfd.append('file', fileInput.files[0]);
                                // å…ˆä¸Šå‚³åˆ° material route ä»¥å–å¾— drive_file_idï¼ˆä½†ä¸å»ºç«‹èª²ä»¶ï¼‰â€”ç°¡åŒ–æ­¤è™•ç•¥éï¼›ç›´æ¥äº¤ç”±å¾Œç«¯ assignment routeè™•ç†é™„ä»¶ä¸Šå‚³
                                // ç•™ç©ºï¼šé™„ä»¶ç”±å¾Œç«¯ç›´æ¥å¾ assignmentFile æ¥æ”¶ï¼ˆè‹¥å¾Œç«¯æ”¯æŒï¼‰ã€‚
                            }
                            const resp = await fetch('/api/classroom/assignment/create', { method: 'POST', body: fd });
                            const data = await resp.json();
                            showMessage(data.message, data.status);
                            if (data.status === 'success') {
                                document.getElementById('assignmentTitle').value = '';
                                document.getElementById('assignmentDescription').value = '';
                                document.getElementById('assignmentMaxPoints').value = '';
                                document.getElementById('dueYear').value = '';
                                document.getElementById('dueMonth').value = '';
                                document.getElementById('dueDay').value = '';
                                document.getElementById('dueHour').value = '';
                                document.getElementById('dueMinute').value = '';
                                loadCoursework(selectedCourseId);
                            }
                        } catch (e) {
                            showMessage('ç™¼å¸ƒä½œæ¥­å¤±æ•—: ' + e.message, 'error');
                        } finally {
                            showLoading(false);
                        }
                    }
            } catch (error) {
                console.error('è¼‰å…¥ä¸»é¡Œå¤±æ•—:', error);
            }
        }

        async function publishMaterial() {
            if (!selectedCourseId) {
                showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                return;
            }
            
            const title = document.getElementById('materialTitle').value;
            if (!title) {
                showMessage('è«‹è¼¸å…¥èª²ä»¶æ¨™é¡Œ', 'error');
                return;
            }
            
            const fd = new FormData();
            fd.append('course_id', selectedCourseId);
            fd.append('title', title);
            fd.append('description', document.getElementById('materialDescription').value);
            fd.append('topic_id', document.getElementById('materialTopic').value);
            fd.append('link_url', document.getElementById('materialLink').value);
            fd.append('state', document.getElementById('materialState').value);
            const fileInput = document.getElementById('materialFile');
            if (fileInput.files && fileInput.files[0]) {
                fd.append('file', fileInput.files[0]);
            }
            if (window.selectedDriveFileId) {
                fd.append('drive_file_id', window.selectedDriveFileId);
            }
            
            showLoading(true);
            try {
                const response = await fetch('/api/classroom/material/create', {
                    method: 'POST',
                    body: fd
                });
                const data = await response.json();
                showMessage(data.message, data.status);
                
                if (data.status === 'success') {
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('materialTitle').value = '';
                    document.getElementById('materialDescription').value = '';
                    document.getElementById('materialLink').value = '';
                }
            } catch (error) {
                showMessage('ç™¼å¸ƒèª²ä»¶å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function searchDrive() {
            try {
                const q = document.getElementById('driveQuery').value;
                const resp = await fetch(`/api/drive/files?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                if (data.status === 'success') {
                    const container = document.getElementById('driveResults');
                    container.innerHTML = '';
                    data.files.forEach(f => {
                        const div = document.createElement('div');
                        div.style.padding = '8px';
                        div.style.borderBottom = '1px solid #eee';
                        div.innerHTML = `<strong>${f.name}</strong> <small>(${f.mimeType})</small>`;
                        div.onclick = () => {
                            window.selectedDriveFileId = f.id;
                            [...container.children].forEach(c => c.style.background='');
                            div.style.background = '#e3f2fd';
                        };
                        container.appendChild(div);
                    });
                    showMessage(`æ‰¾åˆ° ${data.count} å€‹æª”æ¡ˆ`);
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (e) {
                showMessage('æœå°‹ Drive å¤±æ•—: ' + e.message, 'error');
            }
        }

        // CSV å°å…¥ä¸»é¡Œ
        async function importTopicsFromCSV() {
            if (!selectedCourseId) {
                showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                return;
            }
            const fileInput = document.getElementById('topicCsv');
            if (!fileInput.files || !fileInput.files[0]) {
                showMessage('è«‹é¸æ“‡ CSV æª”æ¡ˆ', 'error');
                return;
            }
            const fd = new FormData();
            fd.append('course_id', selectedCourseId);
            fd.append('file', fileInput.files[0]);
            showLoading(true);
            try {
                const resp = await fetch('/api/classroom/topics/import', { method: 'POST', body: fd });
                const data = await resp.json();
                showMessage(data.message, data.status);
                if (data.status === 'success') {
                    loadTopics(selectedCourseId);
                }
            } catch (e) {
                showMessage('å°å…¥ä¸»é¡Œå¤±æ•—: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadCoursework(courseId) {
            try {
                const response = await fetch(`/api/classroom/coursework/${courseId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const select = document.getElementById('courseworkSelect');
                    select.innerHTML = '<option value="">è«‹é¸æ“‡ä½œæ¥­</option>';
                    
                    data.coursework.forEach(work => {
                        const option = document.createElement('option');
                        option.value = work.id;
                        option.textContent = work.title;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½œæ¥­å¤±æ•—:', error);
            }
        }

        async function checkSubmissions() {
            if (!selectedCourseId) {
                showMessage('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'error');
                return;
            }
            
            const courseworkId = document.getElementById('courseworkSelect').value;
            if (!courseworkId) {
                showMessage('è«‹é¸æ“‡ä½œæ¥­', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch(`/api/classroom/submissions/${selectedCourseId}/${courseworkId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const stats = data.stats;
                    const statsDiv = document.getElementById('submissionStats');
                    statsDiv.innerHTML = `
                        <div class="stat-card">
                            <h3>${stats.total}</h3>
                            <p>ç¸½å­¸ç”Ÿæ•¸</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.turned_in}</h3>
                            <p>å·²ç¹³äº¤</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.late}</h3>
                            <p>é²äº¤</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.turned_in_percentage}%</h3>
                            <p>ç¹³äº¤ç‡</p>
                        </div>
                    `;
                    showMessage('é€²åº¦çµ±è¨ˆå·²æ›´æ–°', 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('æª¢æŸ¥é€²åº¦å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
