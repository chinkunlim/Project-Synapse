{% extends "base.html" %}

{% block title %}Automation | Project Synapse{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
    <div>
        <h2 class="fw-bold text-danger mb-1 d-flex align-items-center gap-2">
            <i class="fa-solid fa-bolt"></i> Automation <span class="fs-4 text-muted fw-normal">自動化中心</span>
        </h2>
        <p class="text-muted mb-0">Workflow Management & Execution / 工作流管理與執行 (Powered by N8N)</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadWorkflows()">
            <i class="fa-solid fa-rotate me-2"></i> Refresh <span class="small ms-1">刷新</span>
        </button>
        <a href="http://localhost:5678" target="_blank" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm">
            <img src="{{ url_for('static', filename='img/n8n_logo.png') }}" alt="N8N" height="18"
                style="width: auto; vertical-align: middle;">
        </a>
    </div>
</div>

<div class="row g-4" id="workflow-list">
    <!-- Workflows will be loaded here -->
    <div class="col-12 text-center py-5">
        <div class="spinner-border text-danger opacity-50" role="status"></div>
        <p class="mt-3 text-muted small">Connecting to N8N... / 連線中...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadWorkflows();
    });

    async function loadWorkflows() {
        const listDiv = document.getElementById('workflow-list');
        // Initial Loading State handled in HTML

        try {
            const res = await fetch('/api/n8n/workflows');
            const data = await res.json();

            listDiv.innerHTML = '';

            if (data.status === 'success' && data.workflows.length > 0) {
                data.workflows.forEach(wf => {
                    const isActive = wf.active;
                    const statusBadge = isActive
                        ? '<span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill"><i class="fa-solid fa-circle-check me-1"></i> Active</span>'
                        : '<span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill"><i class="fa-regular fa-circle-stop me-1"></i> Inactive</span>';

                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-4';
                    col.innerHTML = `
                        <div class="card h-100 shadow-sm border-0 position-relative workflow-card">
                            <div class="card-body p-4 d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    ${statusBadge}
                                    <small class="text-muted font-monospace bg-light px-2 rounded">#${wf.id.substring(0, 6)}</small>
                                </div>
                                <h5 class="card-title fw-bold text-dark mb-2">${wf.name}</h5>
                                <p class="card-text text-muted small mb-4 flex-grow-1"><i class="fa-regular fa-clock me-1"></i> Updated: ${new Date(wf.updatedAt).toLocaleDateString()}</p>
                                
                                <div class="d-grid gap-2 mt-auto">
                                     <button class="btn btn-outline-danger btn-sm rounded-pill py-2" onclick="executeWorkflow('${wf.id}', '${wf.name}')">
                                        <i class="fa-solid fa-play me-2"></i> Run Workflow <span class="small ms-1">執行</span>
                                    </button>
                                    <a href="http://localhost:5678/workflow/${wf.id}" target="_blank" class="btn btn-light btn-sm text-secondary rounded-pill py-2">
                                        <i class="fa-solid fa-up-right-from-square me-2"></i> Editor <span class="small ms-1">編輯</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    listDiv.appendChild(col);
                });

                window.synapseConsole.log(`Loaded ${data.workflows.length} workflows from N8N.`, 'success');
            } else {
                listDiv.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="bg-light rounded-circle d-inline-flex p-4 mb-3 text-muted">
                             <i class="fa-regular fa-folder-open fa-3x"></i>
                        </div>
                        <h5 class="text-dark">No Workflows Found / 找不到工作流</h5>
                        <p class="text-muted small">Check if N8N is running and has workflows.</p>
                        <small class="text-danger font-monospace">${data.message || ''}</small>
                    </div>
                `;
            }
        } catch (e) {
            listDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex p-4 mb-3 text-danger">
                        <i class="fa-solid fa-triangle-exclamation fa-3x"></i>
                    </div>
                    <h5 class="text-danger">Connection Error / 連線錯誤</h5>
                    <p class="text-muted small">${e.message}</p>
                </div>
            `;
            window.synapseConsole.log('N8N Load Error: ' + e.message, 'error');
        }
    }

    async function executeWorkflow(id, name) {
        if (!confirm(`Are you sure you want to trigger "${name}"? \n確定要執行此工作流嗎？`)) return;

        window.synapseConsole.log(`Triggering workflow: ${name}...`, 'info');
        showToast('Triggering workflow...', 'info');

        try {
            const res = await fetch(`/api/n8n/execute/${id}`, { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                window.synapseConsole.log(`Workflow "${name}" executed successfully.`, 'success');
                showToast('Execution successful!', 'success');
            } else {
                window.synapseConsole.log(`Execution failed: ${data.message}`, 'error');
                showToast('Execution failed.', 'error');
            }
        } catch (e) {
            window.synapseConsole.log(`Execution error: ${e.message}`, 'error');
            showToast('Error: ' + e.message, 'error');
        }
    }
</script>

<style>
    .workflow-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .workflow-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08) !important;
        border-color: var(--bs-danger) !important;
    }
</style>
{% endblock %}