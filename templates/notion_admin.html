<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <title>Notion ç®¡ç†ä¸­æ¨ | Project Synapse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.show {
            display: flex;
        }
        .spinner-container {
            text-align: center;
            color: white;
        }
        .log-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-output .success { color: #4ec9b0; }
        .log-output .error { color: #f48771; }
        .log-output .warning { color: #dcdcaa; }
        .log-output .info { color: #9cdcfe; }
        .action-card {
            transition: transform 0.2s;
        }
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body class="bg-light">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 id="loadingMessage">è™•ç†ä¸­...</h4>
        </div>
    </div>

    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-gear-fill"></i> Notion ç³»çµ±ç®¡ç†ä¸­æ¨</h2>
                <p class="text-muted mb-0">é›†ä¸­ç®¡ç†æ‰€æœ‰ Notion ç›¸é—œæ“ä½œ</p>
            </div>
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›å„€è¡¨æ¿
            </a>
        </div>

        <!-- System Status -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle-fill"></i> ç³»çµ±ç‹€æ…‹</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-key-fill me-2"></i>
                                    <strong>API Key:</strong>
                                    <span class="ms-2 badge {{ 'bg-success' if 'å·²è¨­å®š' in status.api_key else 'bg-danger' }}">
                                        {{ status.api_key }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    <strong>Parent Page:</strong>
                                    <span class="ms-2 badge {{ 'bg-success' if 'å·²è¨­å®š' in status.parent_id else 'bg-danger' }}">
                                        {{ status.parent_id }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-database me-2"></i>
                                    <strong>Task Database:</strong>
                                    <span class="ms-2 badge {{ 'bg-success' if 'å·²è¨­å®š' in status.task_db else 'bg-warning' }}">
                                        {{ status.task_db }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <button onclick="runAction('test_connection')" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-wifi"></i> æ¸¬è©¦é€£æ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operations Grid -->
        <div class="row g-4 mb-4">
            <!-- Basic Operations -->
            <div class="col-md-6">
                <div class="card shadow-sm action-card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-play-circle-fill"></i> åŸºæœ¬æ“ä½œ</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button onclick="runAction('test_connection')" class="btn btn-outline-success">
                                <i class="bi bi-wifi"></i> æ¸¬è©¦ Notion é€£æ¥
                            </button>
                            <button onclick="runAction('build_layout')" class="btn btn-outline-primary">
                                <i class="bi bi-layout-text-window-reverse"></i> æ§‹å»ºå„€è¡¨æ¿ä½ˆå±€
                            </button>
                            <button onclick="runAction('create_databases')" class="btn btn-outline-info">
                                <i class="bi bi-database-add"></i> å‰µå»ºæ•¸æ“šåº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Setup -->
            <div class="col-md-6">
                <div class="card shadow-sm action-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-rocket-takeoff-fill"></i> å¿«é€Ÿè¨­ç½®</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <i class="bi bi-info-circle"></i> ä¸€éµå®Œæˆæ‰€æœ‰åˆå§‹åŒ–æ­¥é©Ÿ
                        </p>
                        <div class="d-grid gap-2">
                            <button onclick="runAction('init_all')" class="btn btn-primary btn-lg">
                                <i class="bi bi-rocket-takeoff"></i> ä¸€éµåˆå§‹åŒ–æ‰€æœ‰è³‡æ–™åº«
                            </button>
                            <small class="text-muted">
                                åŒ…å«: æ¸¬è©¦é€£æ¥ â†’ æ§‹å»ºä½ˆå±€ â†’ å‰µå»ºæ•¸æ“šåº«
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Management -->
            <div class="col-md-6">
                <div class="card shadow-sm action-card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-database-fill"></i> æ•¸æ“šåº«ç®¡ç†</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button onclick="runAction('list_databases')" class="btn btn-outline-info">
                                <i class="bi bi-list-ul"></i> åˆ—å‡ºæ‰€æœ‰æ•¸æ“šåº«
                            </button>
                            <button onclick="runAction('check_schema')" class="btn btn-outline-secondary">
                                <i class="bi bi-file-code"></i> æª¢æŸ¥ Schema é…ç½®
                            </button>
                            <button onclick="runAction('show_env')" class="btn btn-outline-secondary">
                                <i class="bi bi-gear"></i> é¡¯ç¤ºç’°å¢ƒè®Šæ•¸
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Import/Export -->
            <div class="col-md-6">
                <div class="card shadow-sm action-card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-spreadsheet"></i> CSV æ•¸æ“šå°å…¥</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <i class="bi bi-info-circle"></i> ä¸Šå‚³ CSV æ–‡ä»¶æ‰¹é‡å°å…¥æ•¸æ“š
                        </p>
                        
                        <!-- æ•¸æ“šåº«é¸æ“‡ -->
                        <div class="mb-3">
                            <label for="targetDatabase" class="form-label">é¸æ“‡ç›®æ¨™æ•¸æ“šåº«</label>
                            <select id="targetDatabase" class="form-select">
                                <option value="">-- è«‹é¸æ“‡æ•¸æ“šåº« --</option>
                                <option value="tasks">Tasks (ä»»å‹™)</option>
                                <option value="courses">Courses (èª²ç¨‹)</option>
                                <option value="projects">Projects (å°ˆæ¡ˆ)</option>
                                <option value="sessions">Sessions (èª²å ‚)</option>
                                <option value="notes">Notes (ç­†è¨˜)</option>
                                <option value="resources">Resources (è³‡æº)</option>
                            </select>
                        </div>
                        
                        <!-- CSV ä¸Šå‚³ -->
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">é¸æ“‡ CSV æ–‡ä»¶</label>
                            <input type="file" class="form-control" id="csvFile" accept=".csv">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button onclick="uploadCSV()" class="btn btn-success">
                                <i class="bi bi-upload"></i> ä¸Šå‚³ä¸¦å°å…¥
                            </button>
                            <button onclick="downloadSample()" class="btn btn-outline-success">
                                <i class="bi bi-download"></i> ä¸‹è¼‰ CSV æ¨£æœ¬
                            </button>
                        </div>
                        
                        <small class="text-muted d-block mt-2">
                            * è«‹å…ˆä¸‹è¼‰æ¨£æœ¬æŸ¥çœ‹æ ¼å¼ï¼Œå†æº–å‚™æ‚¨çš„ CSV æ–‡ä»¶
                        </small>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="col-md-6">
                                <i class="bi bi-file-code"></i> æª¢æŸ¥ Schema é…ç½®
                            </button>
                            <button onclick="runAction('show_env')" class="btn btn-outline-secondary">
                                <i class="bi bi-gear"></i> é¡¯ç¤ºç’°å¢ƒè®Šæ•¸
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="col-md-6">
                <div class="card shadow-sm action-card h-100 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> å±éšªå€åŸŸ</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-danger mb-3">
                            <strong><i class="bi bi-exclamation-circle"></i> è­¦å‘Šï¼š</strong>
                            ä»¥ä¸‹æ“ä½œæœƒåˆªé™¤æ•¸æ“šï¼Œè«‹è¬¹æ…ä½¿ç”¨ï¼
                        </p>
                        <div class="d-grid gap-2">
                            <button onclick="runAction('clean')" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i> æ¸…ç©ºé é¢å…§å®¹
                            </button>
                            <button onclick="runAction('reset_all')" class="btn btn-danger">
                                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®æ‰€æœ‰è¨­ç½®
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            * é‡ç½®æ“ä½œæœƒæ¸…ç©ºé é¢ä¸¦é‡æ–°åˆå§‹åŒ–
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Output -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> æ“ä½œæ—¥èªŒ</h5>
                        <button onclick="clearLog()" class="btn btn-sm btn-outline-light">
                            <i class="bi bi-x-circle"></i> æ¸…ç©º
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="logOutput" class="log-output">
                            <span class="info">ğŸ¯ Notion ç®¡ç†ä¸­æ¨å·²å°±ç·’</span>
                            <span class="info">ğŸ“ è«‹é¸æ“‡ä¸Šæ–¹çš„æ“ä½œæŒ‰éˆ•é–‹å§‹ä½¿ç”¨</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logLine = document.createElement('div');
            logLine.className = type;
            logLine.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logLine);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = '<span class="info">ğŸ“ æ—¥èªŒå·²æ¸…ç©º</span>';
        }

        async function runAction(actionName) {
            const actionMessages = {
                'test_connection': 'æ¸¬è©¦ Notion API é€£æ¥',
                'build_layout': 'æ§‹å»ºå„€è¡¨æ¿ä½ˆå±€',
                'create_databases': 'å‰µå»ºæ•¸æ“šåº«',
                'init_all': 'ä¸€éµåˆå§‹åŒ–æ‰€æœ‰è³‡æ–™åº«',
                'clean': 'æ¸…ç©ºé é¢å…§å®¹',
                'reset_all': 'é‡ç½®æ‰€æœ‰è¨­ç½®',
                'list_databases': 'åˆ—å‡ºæ‰€æœ‰æ•¸æ“šåº«',
                'check_schema': 'æª¢æŸ¥ Schema é…ç½®',
                'show_env': 'é¡¯ç¤ºç’°å¢ƒè®Šæ•¸'
            };

            const dangerActions = ['clean', 'reset_all'];
            
            if (dangerActions.includes(actionName)) {
                if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åŸ·è¡Œã€Œ${actionMessages[actionName]}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œå¯èƒ½æœƒåˆªé™¤æ•¸æ“šï¼`)) {
                    addLog('âŒ æ“ä½œå·²å–æ¶ˆ', 'warning');
                    return;
                }
            }

            addLog(`ğŸš€ é–‹å§‹åŸ·è¡Œ: ${actionMessages[actionName]}`, 'info');
            showLoading(`æ­£åœ¨åŸ·è¡Œ: ${actionMessages[actionName]}...`);

            try {
                const response = await fetch('/api/notion/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: actionName })
                });

                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    addLog(`âœ… ${data.message}`, 'success');
                    if (data.details) {
                        addLog(`ğŸ“Š è©³ç´°ä¿¡æ¯: ${JSON.stringify(data.details, null, 2)}`, 'info');
                    }
                    if (data.logs) {
                        data.logs.forEach(log => addLog(`   ${log}`, 'info'));
                    }
                } else {
                    addLog(`âŒ ${data.message}`, 'error');
                    if (data.error) {
                        addLog(`   éŒ¯èª¤è©³æƒ…: ${data.error}`, 'error');
                    }
                }
            } catch (error) {
                addLog(`âŒ è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(() => {
            addLog('ğŸ”„ è‡ªå‹•åˆ·æ–°ç³»çµ±ç‹€æ…‹...', 'info');
            location.reload();
        }, 300000); // 5 minutes

        // CSV Upload Function
        async function uploadCSV() {
            const databaseSelect = document.getElementById('targetDatabase');
            const fileInput = document.getElementById('csvFile');
            
            const databaseType = databaseSelect.value;
            const file = fileInput.files[0];
            
            if (!databaseType) {
                alert('âš ï¸ è«‹é¸æ“‡ç›®æ¨™æ•¸æ“šåº«');
                return;
            }
            
            if (!file) {
                alert('âš ï¸ è«‹é¸æ“‡ CSV æ–‡ä»¶');
                return;
            }
            
            // ç²å–å°æ‡‰çš„æ•¸æ“šåº« ID
            const databaseId = getDatabaseId(databaseType);
            if (!databaseId) {
                alert('âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„æ•¸æ“šåº« IDï¼Œè«‹å…ˆå‰µå»ºæ•¸æ“šåº«');
                return;
            }
            
            addLog(`ğŸš€ é–‹å§‹ä¸Šå‚³ CSV: ${file.name}`, 'info');
            showLoading(`æ­£åœ¨ä¸Šå‚³ä¸¦å°å…¥ CSV æ–‡ä»¶...`);
            
            try {
                const formData = new FormData();
                formData.append('csv_file', file);
                formData.append('database_id', databaseId);
                
                const response = await fetch('/api/notion/csv/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    addLog(`âœ… ${data.message}`, 'success');
                    addLog(`   å°å…¥: ${data.details.imported} ç­†`, 'success');
                    if (data.details.failed > 0) {
                        addLog(`   å¤±æ•—: ${data.details.failed} ç­†`, 'warning');
                        if (data.details.errors && data.details.errors.length > 0) {
                            data.details.errors.forEach(error => {
                                addLog(`   â€¢ ${error}`, 'error');
                            });
                        }
                    }
                    
                    // æ¸…ç©ºæ–‡ä»¶é¸æ“‡
                    fileInput.value = '';
                } else {
                    addLog(`âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Download CSV Sample
        async function downloadSample() {
            const databaseSelect = document.getElementById('targetDatabase');
            const databaseType = databaseSelect.value;
            
            if (!databaseType) {
                alert('âš ï¸ è«‹å…ˆé¸æ“‡æ•¸æ“šåº«é¡å‹');
                return;
            }
            
            addLog(`ğŸ“¥ ä¸‹è¼‰ ${databaseType} çš„ CSV æ¨£æœ¬...`, 'info');
            
            try {
                const url = `/api/notion/csv/sample/${databaseType}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = `${databaseType}_sample.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog(`âœ… CSV æ¨£æœ¬ä¸‹è¼‰å®Œæˆ`, 'success');
            } catch (error) {
                addLog(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // Get Database ID by type
        function getDatabaseId(databaseType) {
            // é€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›çš„ç’°å¢ƒè®Šæ•¸ä¾†ç²å–
            const databaseMap = {
                'tasks': '{{ task_db_id }}',
                'courses': '{{ course_hub_id }}',
                'projects': '{{ project_db_id }}',
                'sessions': '{{ class_session_id }}',
                'notes': '{{ note_db_id }}',
                'resources': '{{ resource_db_id }}'
            };
            
            return databaseMap[databaseType] || null;
        }
    </script>
</body>

</html>