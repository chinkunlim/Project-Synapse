<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion ç®¡ç†ä¸­æ¨ | Project Synapse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-bg: #1e1e1e;
            --text-light: #d4d4d4;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner-container {
            text-align: center;
            color: white;
        }

        .log-output {
            background: var(--dark-bg);
            color: var(--text-light);
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-left: 4px solid var(--primary-color);
            line-height: 1.6;
        }

        .log-output div {
            margin-bottom: 8px;
        }

        .log-output .success { color: #4ec9b0; font-weight: 500; }
        .log-output .error { color: #f48771; font-weight: 500; }
        .log-output .warning { color: #dcdcaa; font-weight: 500; }
        .log-output .info { color: #9cdcfe; }

        .action-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.1);
            height: 100%;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .card-header {
            font-weight: 600;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .card-header h5 {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header i {
            font-size: 1.2em;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .btn {
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn i {
            margin-right: 6px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .danger-zone {
            border-left: 4px solid var(--danger-color);
            background: rgba(220, 53, 69, 0.05);
        }

        .danger-zone .card-header {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
        }

        .danger-warning {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--danger-color);
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .section-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary-color);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-item i {
            font-size: 1.8em;
            color: var(--primary-color);
        }

        .status-content {
            flex: 1;
        }

        .status-content strong {
            display: block;
            margin-bottom: 4px;
        }

        .log-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .log-scroll::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .log-scroll::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .log-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .card {
                margin-bottom: 20px;
            }
        }

        .main-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .header-section h2 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-section p {
            color: #666;
            margin: 0;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 id="loadingMessage">è™•ç†ä¸­...</h4>
        </div>
    </div>

    <div class="container-xl py-4">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section d-flex justify-content-between align-items-start">
                <div>
                    <h2><i class="bi bi-gear-fill"></i> Notion ç³»çµ±ç®¡ç†ä¸­æ¨</h2>
                    <p class="mb-0">é›†ä¸­ç®¡ç†æ‰€æœ‰ Notion ç›¸é—œæ“ä½œå’Œé…ç½®</p>
                </div>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> è¿”å›å„€è¡¨æ¿
                </a>
            </div>

            <!-- System Status -->
            <div class="mb-4">
                <h3 class="section-title"><i class="bi bi-info-circle-fill"></i> ç³»çµ±ç‹€æ…‹</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <i class="bi bi-key-fill"></i>
                        <div class="status-content">
                            <strong>API Key</strong>
                            <span class="status-badge {{ 'badge-success' if 'å·²è¨­å®š' in status.api_key else 'badge-danger' }}">
                                {{ status.api_key }}
                            </span>
                        </div>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-file-earmark-text"></i>
                        <div class="status-content">
                            <strong>Parent Page</strong>
                            <span class="status-badge {{ 'badge-success' if 'å·²è¨­å®š' in status.parent_id else 'badge-danger' }}">
                                {{ status.parent_id }}
                            </span>
                        </div>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-database"></i>
                        <div class="status-content">
                            <strong>Task Database</strong>
                            <span class="status-badge {{ 'badge-success' if 'å·²è¨­å®š' in status.task_db else 'badge-warning' }}">
                                {{ status.task_db }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button onclick="runAction('test_connection')" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-wifi"></i> æ¸¬è©¦é€£æ¥
                    </button>
                    <button onclick="openEnvModal()" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil-square"></i> ç·¨è¼¯ç’°å¢ƒè®Šæ•¸
                    </button>
                </div>
            </div>

            <!-- Operations Grid -->
            <h3 class="section-title"><i class="bi bi-lightning-charge-fill"></i> æ“ä½œé¢æ¿</h3>
            <div class="row g-4 mb-5">
                <!-- Basic Operations -->
                <div class="col-lg-6">
                    <div class="card shadow-sm action-card">
                        <div class="card-header bg-success text-white">
                            <h5><i class="bi bi-play-circle-fill"></i> åŸºæœ¬æ“ä½œ</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button onclick="runAction('test_connection')" class="btn btn-outline-success">
                                    <i class="bi bi-wifi"></i> æ¸¬è©¦ Notion é€£æ¥
                                </button>
                                <button onclick="runAction('build_layout')" class="btn btn-outline-primary">
                                    <i class="bi bi-layout-text-window-reverse"></i> æ§‹å»ºå„€è¡¨æ¿ä½ˆå±€
                                </button>
                                <button onclick="runAction('create_databases')" class="btn btn-outline-info">
                                    <i class="bi bi-database-add"></i> å‰µå»ºæ•¸æ“šåº«
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Setup -->
                <div class="col-lg-6">
                    <div class="card shadow-sm action-card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="bi bi-rocket-takeoff-fill"></i> å¿«é€Ÿè¨­ç½®</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <i class="bi bi-info-circle"></i> ä¸€éµå®Œæˆæ‰€æœ‰åˆå§‹åŒ–æ­¥é©Ÿ
                            </p>
                            <div class="d-grid gap-2">
                                <button onclick="runAction('init_all')" class="btn btn-primary btn-lg">
                                    <i class="bi bi-rocket-takeoff"></i> ä¸€éµåˆå§‹åŒ–æ‰€æœ‰
                                </button>
                                <small class="text-muted text-center">
                                    é€£æ¥ â†’ ä½ˆå±€ â†’ æ•¸æ“šåº«
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Management -->
                <div class="col-lg-6">
                    <div class="card shadow-sm action-card">
                        <div class="card-header bg-info text-white">
                            <h5><i class="bi bi-database-fill"></i> æ•¸æ“šåº«ç®¡ç†</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button onclick="runAction('list_databases')" class="btn btn-outline-info">
                                    <i class="bi bi-list-ul"></i> åˆ—å‡ºæ‰€æœ‰æ•¸æ“šåº«
                                </button>
                                <button onclick="runAction('check_schema')" class="btn btn-outline-secondary">
                                    <i class="bi bi-file-code"></i> æª¢æŸ¥ Schema é…ç½®
                                </button>
                                <button onclick="runAction('sync_calendar')" class="btn btn-outline-primary">
                                    <i class="bi bi-calendar2-week"></i> åŒæ­¥å­¸æœŸæ—¥æœŸ (Google Calendar)
                                </button>
                                <button onclick="runAction('show_env')" class="btn btn-outline-secondary">
                                    <i class="bi bi-gear"></i> é¡¯ç¤ºç’°å¢ƒè®Šæ•¸
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSV Import/Export -->
                <div class="col-lg-6">
                    <div class="card shadow-sm action-card">
                        <div class="card-header bg-success text-white">
                            <h5><i class="bi bi-file-earmark-spreadsheet"></i> CSV æ•¸æ“šå°å…¥</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <i class="bi bi-info-circle"></i> ä¸Šå‚³ CSV æ–‡ä»¶æ‰¹é‡å°å…¥æ•¸æ“š
                            </p>
                            
                            <!-- æ•¸æ“šåº«é¸æ“‡ -->
                            <div class="mb-3">
                                <label for="targetDatabase" class="form-label">é¸æ“‡ç›®æ¨™æ•¸æ“šåº«</label>
                                <select id="targetDatabase" class="form-select form-select-sm">
                                    <option value="">-- è«‹é¸æ“‡æ•¸æ“šåº« --</option>
                                    <option value="tasks">ä»»å‹™</option>
                                    <option value="courses">èª²ç¨‹</option>
                                    <option value="projects">å°ˆæ¡ˆ</option>
                                    <option value="sessions">èª²å ‚</option>
                                    <option value="notes">ç­†è¨˜</option>
                                    <option value="resources">è³‡æº</option>
                                </select>
                            </div>
                            
                            <!-- èª²ç¨‹å°å…¥æ™‚çš„å­¸æœŸè¨­ç½® -->
                            <div id="semesterSettings" class="mb-3" style="display: none;">
                                <div class="alert alert-info" role="alert">
                                    <i class="bi bi-info-circle"></i> å°å…¥èª²ç¨‹æ™‚ï¼Œè«‹è¨­ç½®å­¸æœŸé–‹å§‹å’ŒçµæŸæ—¥æœŸ
                                </div>
                                <div class="mb-2">
                                    <label for="semesterStart" class="form-label">å­¸æœŸé–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" class="form-control form-control-sm" id="semesterStart">
                                </div>
                                <div class="mb-2">
                                    <label for="semesterEnd" class="form-label">å­¸æœŸçµæŸæ—¥æœŸ</label>
                                    <input type="date" class="form-control form-control-sm" id="semesterEnd">
                                </div>
                                <small class="text-muted">ğŸ’¡ å°‡ç”¨æ–¼è‡ªå‹•ç”Ÿæˆ 18 å ‚èª²ç¨‹æœƒè©±</small>
                            </div>
                            
                            <!-- CSV ä¸Šå‚³ -->
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">é¸æ“‡ CSV æ–‡ä»¶</label>
                                <input type="file" class="form-control form-control-sm" id="csvFile" accept=".csv">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button onclick="uploadCSV()" class="btn btn-success btn-sm">
                                    <i class="bi bi-upload"></i> ä¸Šå‚³ä¸¦å°å…¥
                                </button>
                                <button onclick="downloadSample()" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-download"></i> ä¸‹è¼‰æ¨£æœ¬
                                </button>
                            </div>
                            
                            <small class="text-muted d-block mt-2">
                                ğŸ’¡ è«‹å…ˆä¸‹è¼‰æ¨£æœ¬æŸ¥çœ‹æ ¼å¼
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <h3 class="section-title"><i class="bi bi-exclamation-triangle-fill"></i> å±éšªå€åŸŸ</h3>
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card shadow-sm action-card danger-zone">
                        <div class="card-header">
                            <h5><i class="bi bi-exclamation-circle-fill"></i> ç³»çµ±é‡ç½®èˆ‡æ¸…ç†</h5>
                        </div>
                        <div class="card-body">
                            <div class="danger-warning">
                                <strong><i class="bi bi-exclamation-diamond"></i> å±éšªè­¦å‘Š</strong>
                                <p class="mb-0 mt-2">ä»¥ä¸‹æ“ä½œæœƒæ°¸ä¹…åˆªé™¤æ•¸æ“šï¼Œè«‹åœ¨ç¢ºèªç„¡èª¤å¾Œå†åŸ·è¡Œï¼</p>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button onclick="runAction('clean')" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-trash"></i> æ¸…ç©ºé é¢å…§å®¹
                                    </button>
                                    <small class="text-muted d-block mt-2">æ¸…ç©º Notion é é¢ä¸­çš„æ‰€æœ‰å…§å®¹</small>
                                </div>
                                <div class="col-md-6">
                                    <button onclick="runAction('reset_all')" class="btn btn-danger w-100">
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®æ‰€æœ‰è¨­ç½®
                                    </button>
                                    <small class="text-muted d-block mt-2">æ¸…ç©ºå¾Œé‡æ–°åˆå§‹åŒ–æ‰€æœ‰é…ç½®</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Output -->
            <h3 class="section-title"><i class="bi bi-terminal"></i> æ“ä½œæ—¥èªŒ</h3>
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-terminal-fill"></i> å¯¦æ™‚æ“ä½œæ—¥èªŒ</h5>
                    <button onclick="clearLog()" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-x-lg"></i> æ¸…ç©ºæ—¥èªŒ
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="logOutput" class="log-output log-scroll">
                        <div class="info">ğŸ¯ Notion ç®¡ç†ä¸­æ¨å·²å°±ç·’</div>
                        <div class="info">ğŸ“ è«‹é¸æ“‡ä¸Šæ–¹çš„æ“ä½œæŒ‰éˆ•é–‹å§‹ä½¿ç”¨</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Env Modal -->
    <div class="modal fade" id="envModal" tabindex="-1" aria-labelledby="envModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="envModalLabel"><i class="bi bi-gear"></i> ç·¨è¼¯ç’°å¢ƒè®Šæ•¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> ä¿®æ”¹å¾Œå°‡ç«‹å³å¯«å…¥ .env ä¸¦æ›´æ–°ç•¶å‰åŸ·è¡Œç’°å¢ƒã€‚
                    </div>
                    <div class="row g-3" id="envForm">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveEnvVars()">
                        <i class="bi bi-save"></i> å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logLine = document.createElement('div');
            logLine.className = type;
            logLine.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logLine);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = '<div class="info">ğŸ“ æ—¥èªŒå·²æ¸…ç©º</div>';
        }

        async function runAction(actionName) {
            const actionMessages = {
                'test_connection': 'æ¸¬è©¦ Notion API é€£æ¥',
                'build_layout': 'æ§‹å»ºå„€è¡¨æ¿ä½ˆå±€',
                'create_databases': 'å‰µå»ºæ•¸æ“šåº«',
                'init_all': 'ä¸€éµåˆå§‹åŒ–æ‰€æœ‰è³‡æ–™åº«',
                'clean': 'æ¸…ç©ºé é¢å…§å®¹',
                'reset_all': 'é‡ç½®æ‰€æœ‰è¨­ç½®',
                'list_databases': 'åˆ—å‡ºæ‰€æœ‰æ•¸æ“šåº«',
                'check_schema': 'æª¢æŸ¥ Schema é…ç½®',
                'show_env': 'é¡¯ç¤ºç’°å¢ƒè®Šæ•¸',
                'sync_calendar': 'åŒæ­¥å­¸æœŸèµ·è¿„æ—¥ (Google Calendar)',
                'get_env': 'è®€å–ç’°å¢ƒè®Šæ•¸'
            };

            const dangerActions = ['clean', 'reset_all'];
            
            if (dangerActions.includes(actionName)) {
                if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åŸ·è¡Œã€Œ${actionMessages[actionName]}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œå¯èƒ½æœƒåˆªé™¤æ•¸æ“šï¼`)) {
                    addLog('âŒ æ“ä½œå·²å–æ¶ˆ', 'warning');
                    return;
                }
            }

            addLog(`ğŸš€ é–‹å§‹åŸ·è¡Œ: ${actionMessages[actionName]}`, 'info');
            showLoading(`æ­£åœ¨åŸ·è¡Œ: ${actionMessages[actionName]}...`);

            try {
                const response = await fetch('/api/notion/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: actionName })
                });

                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    addLog(`âœ… ${data.message}`, 'success');
                    if (data.details) {
                        addLog(`ğŸ“Š è©³ç´°ä¿¡æ¯: ${JSON.stringify(data.details, null, 2)}`, 'info');
                    }
                    if (data.logs) {
                        data.logs.forEach(log => addLog(`   ${log}`, 'info'));
                    }
                } else {
                    addLog(`âŒ ${data.message}`, 'error');
                    if (data.error) {
                        addLog(`   éŒ¯èª¤è©³æƒ…: ${data.error}`, 'error');
                    }
                }
            } catch (error) {
                addLog(`âŒ è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(() => {
            addLog('ğŸ”„ è‡ªå‹•åˆ·æ–°ç³»çµ±ç‹€æ…‹...', 'info');
            location.reload();
        }, 300000); // 5 minutes

        // Env Modal Helpers
        async function openEnvModal() {
            try {
                const res = await fetch('/api/notion/env/all');
                const data = await res.json();
                if (!res.ok || data.status !== 'success') {
                    addLog(`âŒ ç„¡æ³•è®€å–ç’°å¢ƒè®Šæ•¸: ${data.message || res.status}`, 'error');
                    return;
                }
                const env = data.data || {};
                const form = document.getElementById('envForm');
                form.innerHTML = '';
                Object.entries(env).forEach(([key, value]) => {
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `
                        <label class="form-label fw-semibold">${key}</label>
                        <input type="text" class="form-control form-control-sm" id="env_${key}" value="${value || ''}" placeholder="${key}">
                    `;
                    form.appendChild(col);
                });

                const modal = new bootstrap.Modal(document.getElementById('envModal'));
                modal.show();
            } catch (err) {
                addLog(`âŒ è«‹æ±‚å¤±æ•—: ${err.message}`, 'error');
            }
        }

        async function saveEnvVars() {
            try {
                const form = document.getElementById('envForm');
                const inputs = form.querySelectorAll('input');
                const payload = {};
                inputs.forEach(inp => {
                    const key = inp.id.replace('env_', '');
                    payload[key] = inp.value;
                });

                addLog('ğŸ’¾ æ­£åœ¨æ›´æ–°ç’°å¢ƒè®Šæ•¸...', 'info');
                const res = await fetch('/api/notion/env/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                    addLog('âœ… ç’°å¢ƒè®Šæ•¸å·²æ›´æ–°ä¸¦å¯«å…¥ .env', 'success');
                    const modalEl = document.getElementById('envModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                } else {
                    addLog(`âŒ æ›´æ–°å¤±æ•—: ${data.message || res.status}`, 'error');
                    if (data.error) addLog(data.error, 'error');
                }
            } catch (err) {
                addLog(`âŒ è«‹æ±‚å¤±æ•—: ${err.message}`, 'error');
            }
        }

        // CSV Upload Function
        async function uploadCSV() {
            const databaseSelect = document.getElementById('targetDatabase');
            const fileInput = document.getElementById('csvFile');
            
            const databaseType = databaseSelect.value;
            const file = fileInput.files[0];
            
            if (!databaseType) {
                alert('âš ï¸ è«‹é¸æ“‡ç›®æ¨™æ•¸æ“šåº«');
                return;
            }
            
            if (!file) {
                alert('âš ï¸ è«‹é¸æ“‡ CSV æ–‡ä»¶');
                return;
            }
            
            // æª¢æŸ¥èª²ç¨‹å°å…¥æ˜¯å¦æä¾›äº†æ—¥æœŸ
            if (databaseType === 'courses') {
                const startDate = document.getElementById('semesterStart').value;
                const endDate = document.getElementById('semesterEnd').value;
                
                if (!startDate || !endDate) {
                    alert('âš ï¸ å°å…¥èª²ç¨‹æ™‚ï¼Œè«‹è¨­ç½®å­¸æœŸçš„é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                    return;
                }
            }
            
            // ç²å–å°æ‡‰çš„æ•¸æ“šåº« ID
            const databaseId = getDatabaseId(databaseType);
            if (!databaseId) {
                alert('âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„æ•¸æ“šåº« IDï¼Œè«‹å…ˆå‰µå»ºæ•¸æ“šåº«');
                return;
            }
            
            addLog(`ğŸš€ é–‹å§‹ä¸Šå‚³ CSV: ${file.name}`, 'info');
            showLoading(`æ­£åœ¨ä¸Šå‚³ä¸¦å°å…¥ CSV æ–‡ä»¶...`);
            
            try {
                const formData = new FormData();
                formData.append('csv_file', file);
                formData.append('database_id', databaseId);
                formData.append('database_type', databaseType);
                
                // å¦‚æœæ˜¯èª²ç¨‹å°å…¥ï¼Œæ·»åŠ å­¸æœŸæ—¥æœŸ
                if (databaseType === 'courses') {
                    formData.append('semester_start', document.getElementById('semesterStart').value);
                    formData.append('semester_end', document.getElementById('semesterEnd').value);
                }
                
                const response = await fetch('/api/notion/csv/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    addLog(`âœ… ${data.message}`, 'success');
                    addLog(`   å°å…¥: ${data.details.imported} ç­†`, 'success');
                    if (data.details.failed > 0) {
                        addLog(`   å¤±æ•—: ${data.details.failed} ç­†`, 'warning');
                        if (data.details.errors && data.details.errors.length > 0) {
                            data.details.errors.forEach(error => {
                                addLog(`   â€¢ ${error}`, 'error');
                            });
                        }
                    }
                    
                    // æ¸…ç©ºæ–‡ä»¶é¸æ“‡
                    fileInput.value = '';
                } else {
                    addLog(`âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Download CSV Sample
        async function downloadSample() {
            const databaseSelect = document.getElementById('targetDatabase');
            const databaseType = databaseSelect.value;
            
            if (!databaseType) {
                alert('âš ï¸ è«‹å…ˆé¸æ“‡æ•¸æ“šåº«é¡å‹');
                return;
            }
            
            addLog(`ğŸ“¥ ä¸‹è¼‰ ${databaseType} çš„ CSV æ¨£æœ¬...`, 'info');
            
            try {
                const url = `/api/notion/csv/sample/${databaseType}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = `${databaseType}_sample.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog(`âœ… CSV æ¨£æœ¬ä¸‹è¼‰å®Œæˆ`, 'success');
            } catch (error) {
                addLog(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // Get Database ID by type
        function getDatabaseId(databaseType) {
            // é€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›çš„ç’°å¢ƒè®Šæ•¸ä¾†ç²å–
            const databaseMap = {
                'tasks': '{{ task_db_id }}',
                'courses': '{{ course_hub_id }}',
                'projects': '{{ project_db_id }}',
                'sessions': '{{ class_session_id }}',
                'notes': '{{ note_db_id }}',
                'resources': '{{ resource_db_id }}'
            };
            
            return databaseMap[databaseType] || null;
        }

        // ç›£è½æ•¸æ“šåº«é¸æ“‡è®ŠåŒ–ï¼Œé¡¯ç¤º/éš±è—å­¸æœŸè¨­ç½®
        document.getElementById('targetDatabase').addEventListener('change', function() {
            const semesterSettings = document.getElementById('semesterSettings');
            if (this.value === 'courses') {
                semesterSettings.style.display = 'block';
            } else {
                semesterSettings.style.display = 'none';
            }
        });
    </script>
</body>

</html>