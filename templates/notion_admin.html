{% extends "base.html" %}

{% block title %}Notion Admin | Project Synapse{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h4 id="loadingMessage" class="fw-light">Processing...</h4>
</div>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
    <div>
        <h2 class="fw-bold text-primary mb-1 d-flex align-items-center gap-2">
            <i class="fa-solid fa-shapes"></i> Notion Admin <span class="fs-4 text-muted fw-normal">管理中樞</span>
        </h2>
        <p class="text-muted mb-0">System Configuration & Data Management / 系統設定與數據管理</p>
    </div>
    <div class="d-flex gap-2">
        <button onclick="runAction('test_connection')" class="btn btn-outline-primary shadow-sm rounded-pill px-4">
            <i class="fa-solid fa-wifi me-2"></i> Test Connection
        </button>
    </div>
</div>

<!-- Main Operations Grid -->
<div class="row g-4 mb-4">
    <!-- 1. System Status (Top Left) -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom pt-4 pb-2">
                <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-server text-info me-2"></i> System Status <span
                        class="fs-6 text-muted fw-normal ms-1">系統狀態</span></h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-3">
                    <!-- API Status -->
                    <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                        <span class="fw-medium text-secondary">Notion API Connection</span>
                        <span
                            class="badge {{ 'bg-success-subtle text-success border border-success-subtle' if '已設定' in status.api_key else 'bg-danger-subtle text-danger border border-danger-subtle' }} rounded-pill">
                            <i class="fa-solid fa-circle mw-1 me-1" style="font-size:0.6em"></i> {{ status.api_key }}
                        </span>
                    </div>
                    <!-- Parent Page -->
                    <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                        <span class="fw-medium text-secondary">Parent Page (主頁面)</span>
                        <span
                            class="badge {{ 'bg-success-subtle text-success border border-success-subtle' if '已設定' in status.parent_id else 'bg-danger-subtle text-danger border border-danger-subtle' }} rounded-pill">
                            <i class="fa-solid fa-circle mw-1 me-1" style="font-size:0.6em"></i> {{ status.parent_id }}
                        </span>
                    </div>
                    <!-- Task Database -->
                    <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                        <span class="fw-medium text-secondary">Task Database (任務庫)</span>
                        <span
                            class="badge {{ 'bg-success-subtle text-success border border-success-subtle' if '已設定' in status.task_db else 'bg-warning-subtle text-warning border border-warning-subtle' }} rounded-pill">
                            <i class="fa-solid fa-circle mw-1 me-1" style="font-size:0.6em"></i> {{ status.task_db }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Data Management (Top Right) -->
    <div class="col-lg-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white border-bottom pt-4 pb-2">
                <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-server text-info me-2"></i> Data Management
                    <span class="fs-6 text-muted fw-normal ms-1">數據管理</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-4">Tools for managing database configurations and external syncs.
                    <br>用於管理資料庫配置與外部同步。</p>
                <div class="d-grid gap-3">
                    <button onclick="runAction('list_databases')" class="btn btn-light text-start py-2 border">
                        <i class="fa-solid fa-list me-3 text-secondary"></i> List Database IDs / 列出資料庫 ID
                    </button>
                    <button onclick="runAction('sync_calendar')" class="btn btn-light text-start py-2 border">
                        <i class="fa-solid fa-calendar me-3 text-secondary"></i> Sync Semester Dates / 同步學期日期
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Quick Setup (Bottom Left) -->
    <div class="col-lg-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white border-bottom pt-4 pb-2">
                <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-rocket text-primary me-2"></i> Quick Setup
                    <span class="fs-6 text-muted fw-normal ms-1">快速設置</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-4">Initialize layout and databases with a single click. <br>一鍵完成初始化（結構構建 +
                    資料庫創建）。</p>
                <div class="d-grid gap-2">
                    <button onclick="runAction('init_all')" class="btn btn-primary py-2 rounded-3 shadow-sm">
                        <i class="fa-solid fa-magic-wand-sparkles me-2"></i> Initialize All / 一鍵初始化
                    </button>
                    <div class="row g-2">
                        <div class="col-6">
                            <button onclick="runAction('build_layout')"
                                class="btn btn-outline-secondary w-100 btn-sm py-2">
                                <i class="fa-solid fa-layer-group me-1"></i> Layout Only / 僅佈局
                            </button>
                        </div>
                        <div class="col-6">
                            <button onclick="runAction('create_databases')"
                                class="btn btn-outline-secondary w-100 btn-sm py-2">
                                <i class="fa-solid fa-plus me-1"></i> DB Only / 僅資料庫
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. CSV Import (Bottom Right) -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom pt-4 pb-2">
                <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-file-csv text-success me-2"></i> CSV Import
                    <span class="fs-6 text-muted fw-normal ms-1">匯入工具</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold text-uppercase text-muted">Target Database /
                            目標資料庫</label>
                        <select id="targetDatabase" class="form-select bg-light border-0 fw-medium">
                            <option value="courses" selected>Course Hub (課程)</option>
                            <option value="tasks">Tasks (任務)</option>
                            <option value="projects">Projects (專案)</option>
                            <option value="sessions">Class Sessions (課程會話)</option>
                            <option value="notes">Notes (筆記)</option>
                            <option value="resources">Resources (資源)</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label small fw-bold text-uppercase text-muted">CSV File / 檔案</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv">
                    </div>
                    <div class="col-12">
                        <button onclick="uploadCSV()" class="btn btn-success w-100 py-2">
                            <i class="fa-solid fa-upload me-1"></i> Import
                        </button>
                    </div>
                    <div class="col-12 text-end">
                        <button onclick="downloadSample()"
                            class="btn btn-link text-decoration-none text-muted btn-sm p-0">
                            Download Sample / 下載範例 CSV <i class="fa-solid fa-download ms-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Danger Zone (Full Width Base) -->
    <div class="col-12">
        <div class="card border border-danger border-opacity-25 shadow-none mt-2 bg-danger-subtle bg-opacity-10">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <strong class="text-danger d-flex align-items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone / 危險區域
                    </strong>
                    <p class="text-secondary small mb-0 mt-1">
                        Use this to reset the entire system. This action is irreversible. <br>
                        此操作將重置系統並刪除所有數據，無法復原。
                    </p>
                </div>
                <button onclick="runAction('reset_all')" class="btn btn-outline-danger">
                    <i class="fa-solid fa-trash-can me-2"></i> Reset System / 重置系統
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Injection of server-side variables for use in external JS
    function getDatabaseId(databaseType) {
        const databaseMap = {
            'tasks': '{{ task_db_id }}',
            'courses': '{{ course_hub_id }}',
            'projects': '{{ project_db_id }}',
            'sessions': '{{ class_session_id }}',
            'notes': '{{ note_db_id }}',
            'resources': '{{ resource_db_id }}'
        };
        return databaseMap[databaseType] || null;
    }
</script>
<script src="{{ url_for('static', filename='js/notion_admin.js') }}"></script>
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(5px);
        background: rgba(44, 62, 80, 0.85);
        /* Proper overlay color */
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
    }

    .loading-overlay.show {
        display: flex;
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>
{% endblock %}