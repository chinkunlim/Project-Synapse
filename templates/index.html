<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Synapse Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { border-radius: 12px; border: none; }
        .card-header { border-radius: 12px 12px 0 0 !important; font-weight: bold; }
        .btn { border-radius: 8px; }
        .status-badge { font-size: 0.9em; padding: 6px 12px; border-radius: 20px; }
    </style>
</head>

<body class="bg-light">
    <div class="container py-5">
        <header class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary">ğŸ§  Project Synapse</h1>
            <p class="lead text-muted">AI åŠ©æ•™ç¥ç¶“ä¸­æ¨ (Classroom + Notion + PDF Engine)</p>
        </header>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-primary">ğŸ“‹ å¾…è¾¦ä»»å‹™åˆ—è¡¨ (From Notion)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">ä»»å‹™åç¨±</th>
                                <th scope="col">æˆªæ­¢æ—¥æœŸ</th>
                                <th scope="col">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td class="fw-bold">{{ task.task }}</td>
                                <td>{{ task.deadline }}</td>
                                <td>{{ task.status }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted py-4">ç›®å‰æ²’æœ‰ä»»å‹™ï¼Œæˆ–ç„¡æ³•é€£ç·šè‡³ Notionã€‚</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 text-info">ğŸ“ å¾…è¾¦ä»»å‹™åˆ—è¡¨ (From NDHU)</h5>
                    <small class="text-muted">Google Tasks</small>
                </div>
                <div class="d-flex gap-2">
                    <button id="ndhu-refresh-btn" type="button" class="btn btn-sm btn-outline-info" onclick="refreshNDHUTasks()">ğŸ”„ åˆ·æ–°</button>
                    <button id="ndhu-auth-btn" type="button" class="btn btn-sm btn-outline-warning" onclick="authenticateNDHU()">ğŸ”‘ èªè­‰</button>
                </div>
            </div>
            <div class="card-body">
                <div id="ndhu-loading" class="text-center text-muted py-4">
                    <p>æ­£åœ¨è¼‰å…¥ NDHU ä»»å‹™...</p>
                </div>
                <div id="ndhu-content" style="display:none;">
                    <div class="mb-3">
                        <h6 class="text-secondary">å»ºç«‹æ–°ä»»å‹™</h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select id="ndhu-tasklist-select" class="form-select">
                                    <option value="" disabled selected>é¸æ“‡ä»»å‹™æ¸…å–®</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input id="ndhu-task-title" type="text" class="form-control" placeholder="ä»»å‹™æ¨™é¡Œ">
                            </div>
                            <div class="col-md-4">
                                <input id="ndhu-task-due" type="datetime-local" class="form-control" placeholder="æˆªæ­¢æ—¥æœŸ (å¯é¸)">
                            </div>
                            <div class="col-12 mt-2">
                                <input id="ndhu-task-notes" type="text" class="form-control" placeholder="å‚™è¨» (å¯é¸)">
                            </div>
                            <div class="col-12 mt-2 text-end">
                                <button id="ndhu-create-btn" class="btn btn-sm btn-primary" onclick="createNDHUTask()">â• å»ºç«‹ä»»å‹™</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">ä»»å‹™/ç­†è¨˜</th>
                                    <th scope="col">æˆªæ­¢æ—¥æœŸ</th>
                                    <th scope="col">ä¾†æº</th>
                                    <th scope="col">ç‹€æ…‹</th>
                                    <th scope="col">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="ndhu-tasks-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="ndhu-error" style="display:none;" class="alert alert-warning mb-0">
                    <p id="ndhu-error-msg"></p>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-warning">ğŸ—’ï¸ Google Keep</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">Google Keep åŒæ­¥å·²åœç”¨ï¼ˆå®˜æ–¹ Keep API scope å—é™ï¼‰ã€‚è«‹ä½¿ç”¨ Google Tasks å€å¡Šç®¡ç†èˆ‡åŒæ­¥å¾…è¾¦ã€‚</p>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white text-dark">
                        <h5 class="mb-0">âš¡ å¿«æ·æ“ä½œ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <a href="/notion" class="btn btn-outline-dark w-100 py-3">âš™ï¸ Notion ç³»çµ±ç®¡ç†</a>
                            </div>
                            <div class="col-md-3">
                                <a href="https://classroom.google.com" class="btn btn-outline-secondary w-100 py-3" target="_blank">ğŸ“ Google Classroom</a>
                            </div>
                            <div class="col-md-3">
                                <form action="/trigger-n8n" method="POST" target="_blank">
                                    <button type="submit" class="btn btn-outline-success w-100 py-3">ğŸš€ è§¸ç™¼ N8N æµç¨‹</button>
                                </form>
                            </div>
                            <div class="col-md-3">
                                <a href="/thesis" class="btn btn-outline-primary w-100 py-3">ğŸ“„ PDF / è«–æ–‡ç·¨è­¯</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer class="text-center text-muted py-4 small">
        &copy; 2025 Project Synapse. Powered by Flask, Notion API, Docker & N8N.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

<script>
    // Toast é€šçŸ¥å®¹å™¨èˆ‡å·¥å…·æ–¹æ³•
    const toastContainer = document.createElement('div');
    toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
    toastContainer.style.zIndex = '1080';
    document.body.appendChild(toastContainer);

    function showToast(message, type = 'info') {
        const bg = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning text-dark' : 'bg-secondary';
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white ${bg}`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 3500 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    // è¼‰å…¥ NDHU ä»»å‹™
    function loadNDHUTasks() {
        const loading = document.getElementById('ndhu-loading');
        const content = document.getElementById('ndhu-content');
        const error = document.getElementById('ndhu-error');
        const tbody = document.getElementById('ndhu-tasks-tbody');
        const authBtn = document.getElementById('ndhu-auth-btn');
        const refreshBtn = document.getElementById('ndhu-refresh-btn');
        const reauthBtn = document.getElementById('ndhu-reauth-btn');
        
        if (refreshBtn) refreshBtn.disabled = true;

        fetch('/api/ndhu/tasks')
            .then(response => {
                if (response.status === 401) {
                    return response.json().then(data => {
                        throw { status: 401, message: data.message };
                    });
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                
                if (data.status === 'success') {
                    if (data.items && data.items.length > 0) {
                        // å»ºç«‹å­ä»»å‹™æ˜ å°„ï¼ˆä¾ parent åˆ†çµ„ï¼‰
                        const childrenMap = {};
                        data.items.forEach(t => {
                            if (t.parent) {
                                (childrenMap[t.parent] ||= []).push(t);
                            }
                        });

                        let html = '';
                        data.items
                            .filter(item => !item.parent) // åƒ…æ¸²æŸ“é ‚å±¤ä»»å‹™
                            .forEach(item => {
                                const badge = item.status === 'completed' 
                                    ? '<span class="badge bg-success">å®Œæˆ</span>' 
                                    : item.status === 'needsAction'
                                    ? '<span class="badge bg-warning">å¾…è¾¦</span>'
                                    : '<span class="badge bg-secondary">å…¶ä»–</span>';

                                const source = '<span class="badge bg-primary">Google Tasks</span>';

                                const due = item.due ? new Date(item.due).toLocaleDateString('zh-TW') : 'ç„¡';
                                const actions = `
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-success" ${item.status === 'completed' ? 'disabled' : ''}
                                            onclick="completeNDHUTask('${item.tasklistId}', '${item.id}')">âœ… å®Œæˆ</button>
                                        <button class="btn btn-outline-danger" onclick="deleteNDHUTask('${item.tasklistId}', '${item.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </div>
                                `;

                                // é¡¯ç¤ºå…§å®¹ï¼ˆnotesï¼‰èˆ‡å­ä»»å‹™æ¸…å–®
                                const notes = item.description ? `<div class="text-muted small">${item.description}</div>` : '';
                                const children = childrenMap[item.id] || [];
                                const childList = children.length
                                    ? `<ul class="small text-muted mb-0">${children.map(c => `<li>${c.title}${c.description ? ' - ' + c.description : ''}</li>`).join('')}</ul>`
                                    : '';

                                html += `
                                    <tr>
                                        <td class="fw-bold">${item.title}${notes}${childList}</td>
                                        <td>${due}</td>
                                        <td>${source}</td>
                                        <td>${badge}</td>
                                        <td>${actions}</td>
                                    </tr>
                                `;
                            });
                        // å°‡ç”Ÿæˆçš„åˆ—æ’å…¥è¡¨æ ¼
                        tbody.innerHTML = html;
                        content.style.display = 'block';
                    } else {
                        error.style.display = 'block';
                        document.getElementById('ndhu-error-msg').innerText = 'ç›®å‰æ²’æœ‰ä»»å‹™ã€‚';
                    }
                    // è¼‰å…¥ä»»å‹™æ¸…å–®ä¸‹æ‹‰
                    loadNDHUTasklists();
                    if (refreshBtn) refreshBtn.disabled = false;
                } else if (data.message && data.message.includes('èªè­‰')) {
                    authBtn.style.display = 'block';
                    error.style.display = 'block';
                    document.getElementById('ndhu-error-msg').innerHTML = 
                        'éœ€è¦èªè­‰ã€‚<a href="javascript:authenticateNDHU()" class="btn-link">é»æ“Šæ­¤è™•èªè­‰</a>';
                } else {
                    error.style.display = 'block';
                    document.getElementById('ndhu-error-msg').innerText = data.message || 'ç„¡æ³•è¼‰å…¥ NDHU ä»»å‹™';
                    if (refreshBtn) refreshBtn.disabled = false;
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                if (err.status === 401) {
                    authBtn.style.display = 'block';
                    error.style.display = 'block';
                    document.getElementById('ndhu-error-msg').innerHTML = 
                        'éœ€è¦èªè­‰ã€‚<a href="javascript:authenticateNDHU()" class="btn-link">é»æ“Šæ­¤è™•èªè­‰</a>';
                } else {
                    error.style.display = 'block';
                    document.getElementById('ndhu-error-msg').innerText = 'è¼‰å…¥å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤');
                }
                if (refreshBtn) refreshBtn.disabled = false;
                if (reauthBtn) reauthBtn.disabled = false;
            });
    }

    // è¼‰å…¥ NDHU ä»»å‹™æ¸…å–®
    function loadNDHUTasklists() {
        const select = document.getElementById('ndhu-tasklist-select');
        if (!select) return;
        fetch('/api/ndhu/tasklists')
            .then(r => r.json())
            .then(data => {
                if (data.status !== 'success') return;
                select.innerHTML = '<option value="" disabled selected>é¸æ“‡ä»»å‹™æ¸…å–®</option>' +
                    data.lists.map(l => `<option value="${l.id}">${l.title}</option>`).join('');
            })
            .catch(() => {});
    }

    // å»ºç«‹ NDHU ä»»å‹™
    function createNDHUTask() {
        const btn = document.getElementById('ndhu-create-btn');
        const listId = document.getElementById('ndhu-tasklist-select').value;
        const title = document.getElementById('ndhu-task-title').value;
        const notes = document.getElementById('ndhu-task-notes').value;
        const dueInput = document.getElementById('ndhu-task-due').value;
        if (!listId || !title) {
            showToast('è«‹é¸æ“‡æ¸…å–®ä¸¦è¼¸å…¥æ¨™é¡Œ', 'warning');
            return;
        }
        btn.disabled = true;
        let due = null;
        if (dueInput) {
            // è½‰æ›ç‚º ISO å­—ä¸²ï¼ˆæœ¬åœ°æ™‚é–“ -> UTC ç•¥éï¼ŒTasks æ”¯æ´ RFC3339ï¼‰
            const d = new Date(dueInput);
            due = d.toISOString();
        }
        fetch('/api/ndhu/tasks/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tasklist_id: listId, title, notes, due })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('ndhu-task-title').value = '';
                document.getElementById('ndhu-task-notes').value = '';
                document.getElementById('ndhu-task-due').value = '';
                refreshNDHUTasks();
                showToast('å·²å»ºç«‹ä»»å‹™', 'success');
            } else {
                showToast('å»ºç«‹å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                if ((data.message || '').includes('é‡æ–°èªè­‰')) {
                    const authBtn = document.getElementById('ndhu-auth-btn');
                    if (authBtn) authBtn.style.display = 'block';
                }
            }
        })
        .catch(err => showToast('å»ºç«‹å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'), 'error'))
        .finally(() => { btn.disabled = false; });
    }

    // å®Œæˆ NDHU ä»»å‹™
    function completeNDHUTask(tasklistId, taskId) {
        fetch('/api/ndhu/tasks/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tasklist_id: tasklistId, task_id: taskId })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                refreshNDHUTasks();
                showToast('å·²æ¨™è¨˜ç‚ºå®Œæˆ', 'success');
            } else {
                showToast('æ¨™è¨˜å®Œæˆå¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            }
        })
        .catch(err => showToast('æ¨™è¨˜å®Œæˆå¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'), 'error'));
    }

    // åˆªé™¤ NDHU ä»»å‹™
    function deleteNDHUTask(tasklistId, taskId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ')) return;
        fetch('/api/ndhu/tasks/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tasklist_id: tasklistId, task_id: taskId })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                refreshNDHUTasks();
                showToast('å·²åˆªé™¤ä»»å‹™', 'success');
            } else {
                showToast('åˆªé™¤å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            }
        })
        .catch(err => showToast('åˆªé™¤å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'), 'error'));
    }

    // NDHU èªè­‰ï¼ˆæ”¯æ´é¦–æ¬¡èªè­‰å’Œé‡æ–°èªè­‰ï¼‰
    function authenticateNDHU() {
        // æª¢æŸ¥æ˜¯å¦å·²èªè­‰ï¼Œå¦‚æœæ˜¯å‰‡å…ˆæ¸…é™¤ token
        fetch('/api/ndhu/tasks', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success' && data.data && data.data.length >= 0) {
                    // å·²èªè­‰ï¼Œè©¢å•æ˜¯å¦é‡æ–°èªè­‰
                    if (!confirm('å·²èªè­‰ã€‚è¦é‡æ–°èªè­‰ä»¥æ›´æ–°æ¬Šé™å—ï¼Ÿ')) return;
                    resetAndAuth();
                } else {
                    // æœªèªè­‰æˆ–å‡ºéŒ¯ï¼Œç›´æ¥èªè­‰
                    showToast('æ­£åœ¨é–‹å•Ÿ Google èªè­‰...', 'info');
                    startAuth();
                }
            })
            .catch(() => {
                // éŒ¯èª¤æˆ–æœªèªè­‰ï¼Œç›´æ¥èªè­‰
                showToast('æ­£åœ¨é–‹å•Ÿ Google èªè­‰...', 'info');
                startAuth();
            });
    }

    function resetAndAuth() {
        showToast('æ­£åœ¨æ¸…é™¤æ†‘è­‰ä¸¦é‡æ–°èªè­‰...', 'info');
        fetch('/api/ndhu/auth/reset', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('å·²æ¸…é™¤æ†‘è­‰ï¼Œè«‹å®Œæˆé‡æ–°èªè­‰', 'success');
                    startAuth();
                } else {
                    showToast('æ¸…é™¤æ†‘è­‰å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            })
            .catch(err => showToast('é‡æ–°èªè­‰å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'), 'error'));
    }

    function startAuth() {
        fetch('/api/ndhu/auth/start')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = data.authorization_url;
                } else {
                    showToast('èªè­‰å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            })
            .catch(err => showToast('ç„¡æ³•ç”¢ç”Ÿèªè­‰ç¶²å€: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'), 'error'));
    }

        // æ‰‹å‹•åˆ·æ–°
        function refreshNDHUTasks() {
            const loading = document.getElementById('ndhu-loading');
            const content = document.getElementById('ndhu-content');
            const error = document.getElementById('ndhu-error');
        
            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';
        
            loadNDHUTasks();
        }

        // è‡ªå‹•åˆ·æ–°è¨ˆæ™‚å™¨ï¼ˆæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
        let ndhuRefreshInterval;
        function startNDHUAutoRefresh() {
            // åˆå§‹è¼‰å…¥
            loadNDHUTasks();
        
            // æ¯ 60 ç§’è‡ªå‹•åˆ·æ–°
            ndhuRefreshInterval = setInterval(loadNDHUTasks, 60000);
        }

        function stopNDHUAutoRefresh() {
            if (ndhuRefreshInterval) {
                clearInterval(ndhuRefreshInterval);
            }
        }

    // ç«‹å³å•Ÿå‹•è‡ªå‹•åˆ·æ–°ï¼ˆè…³æœ¬ä½æ–¼é å°¾ï¼ŒDOM å·²å¯ç”¨ï¼‰
    startNDHUAutoRefresh();

    // é é¢é—œé–‰æ™‚åœæ­¢è¨ˆæ™‚å™¨
    window.addEventListener('beforeunload', stopNDHUAutoRefresh);

    // ç¶å®š NDHU åˆ·æ–°æŒ‰éˆ•äº‹ä»¶
    const refreshBtn = document.getElementById('ndhu-refresh-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', refreshNDHUTasks);

    // Google Keep åŒæ­¥å·²åœç”¨ï¼Œç„¡å‰ç«¯é‚è¼¯

    function initNotion() {
        if (!confirm("é€™å°‡æœƒåœ¨æ‚¨çš„ Notion é é¢å»ºç«‹æ–°è³‡æ–™åº«ï¼Œç¢ºå®šå—ï¼Ÿ")) return;

        const btn = document.getElementById('initBtn');
        const status = document.getElementById('setup-status');

        btn.disabled = true;
        status.className = "mt-2 text-primary";
        status.innerText = "â³ æ­£åœ¨åŸ·è¡Œåˆå§‹åŒ–ï¼Œé€™å¯èƒ½éœ€è¦ä¸€åˆ†é˜ï¼Œè«‹å‹¿é—œé–‰ç¶²é ...";

        fetch('/api/notion/setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    status.className = "mt-2 text-success";
                    status.innerText = "âœ… " + data.message;
                    alert(data.message + " é é¢å³å°‡é‡æ–°æ•´ç†ã€‚");
                    location.reload();
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                status.className = "mt-2 text-danger";
                status.innerText = "âŒ å¤±æ•—: " + error.message;
                btn.disabled = false;
            });
    }
</script>

</html>